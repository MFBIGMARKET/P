<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Order Management</title>
    
    <!-- PWA Meta Tags & Manifest -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#005f73">
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxOTIgMTkyIj48Y2lyY2xlIGN4PSI5NiIgY3k9Ijk2IiByPSI5NiIgZmlsbD0iIzAwNWY3MyIvPjx0ZXh0IHg9Ijk2IiB5PSIxMzYiIGZvbnQtZm1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iOTAiIGZvbnQtd2VpZ2h0PSJib2xkIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjZmZmIj5NRjwvdGV4dD48L3N2Zz4=">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- LeafletJS for Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha2256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- FIREBASE SDKs -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import { getFirestore, initializeFirestore, persistentLocalCache, persistentMultipleTabManager, getDocs, collection, doc, setDoc, onSnapshot, deleteDoc, writeBatch, query, updateDoc, deleteField } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
      
      const firebaseConfig = {
        apiKey: "AIzaSyDdECOGyNKFsKtWDiArUPp0DVd_bN0BjAY",
        authDomain: "bigmarket-order-app.firebaseapp.com",
        projectId: "bigmarket-order-app",
        storageBucket: "bigmarket-order-app.firebasestorage.app",
        messagingSenderId: "905682701991",
        appId: "1:905682701991:web:77b4028bbed29204a59582"
      };

      const app = initializeApp(firebaseConfig);
      
      const db = initializeFirestore(app, {
          localCache: persistentLocalCache({ tabManager: persistentMultipleTabManager() })
      });

      window.firebaseDB = db;
      window.firebaseTools = { getDocs, collection, doc, setDoc, onSnapshot, deleteDoc, writeBatch, query, updateDoc, deleteField };

    </script>
    
    <style>
        :root {
            --primary-color: #005f73;
            --secondary-color: #0a9396;
            --accent-color: #ee9b00;
            --light-bg: #e0f7fa;
            --text-color: #212529;
            --light-text-color: #fff;
            --border-color: #dee2e6;
            --card-shadow: 0 4px 15px rgba(0, 95, 115, 0.1);
            --border-radius: 12px;
            --danger-color: #e63946;
            --success-color: #2a9d8f;
            --warning-color: #fb8500;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        html, body { 
            height: 100%; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; 
            background-color: var(--light-bg); 
            color: var(--text-color); 
            overscroll-behavior-y: contain;
            overflow-x: hidden;
        }
        .page { display: none; flex-direction: column; height: 100%; width: 100%; position: absolute; top: 0; left: 0; background-color: var(--light-bg); transition: transform 0.3s ease-in-out; }
        .page.active { display: flex; }

        .header { background-color: var(--primary-color); color: var(--light-text-color); padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 100; }
        .header h1 { font-size: 1.4rem; font-weight: 600; }
        .header .icon-button { background: none; border: none; color: var(--light-text-color); cursor: pointer; padding: 5px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: background-color 0.2s; position: relative; }
        .header .icon-button:active { background-color: rgba(255, 255, 255, 0.15); }
        .header .header-actions { display: flex; align-items: center; gap: 15px; }

        #cart-item-count {
            position: absolute; top: -4px; right: -6px; background-color: var(--danger-color); color: white; border-radius: 50%; padding: 2px 6px; font-size: 0.7rem; font-weight: bold; line-height: 1; min-width: 20px; text-align: center; border: 2px solid var(--primary-color);
        }

        .content { flex-grow: 1; overflow-y: auto; padding: 15px; }
        .footer { display: flex; justify-content: space-around; background-color: #fff; box-shadow: 0 -2px 8px rgba(0,0,0,0.1); padding: 5px 0 10px 0; flex-shrink: 0; }
        .footer-button { background: none; border: none; color: #888; display: flex; flex-direction: column; align-items: center; font-size: 0.8rem; cursor: pointer; padding: 5px 15px; border-radius: var(--border-radius); transition: color 0.2s; }
        .footer-button.active { color: var(--secondary-color); font-weight: 600; }
        .footer-button svg { width: 26px; height: 26px; margin-bottom: 2px; }

        .card { background-color: #fff; border-radius: var(--border-radius); box-shadow: var(--card-shadow); padding: 16px; margin-bottom: 16px; }
        .card h3 { margin: 0 0 15px 0; color: var(--primary-color); font-size: 1.2rem; }
        
        .button { display: inline-block; width: 100%; padding: 15px; font-size: 1.1rem; font-weight: 600; text-align: center; color: var(--light-text-color); background: linear-gradient(45deg, var(--secondary-color), var(--primary-color)); border: none; border-radius: var(--border-radius); cursor: pointer; transition: opacity 0.3s ease, transform 0.1s ease; box-shadow: 0 4px 10px rgba(0, 95, 115, 0.25); }
        .button:active { transform: scale(0.98); opacity: 0.9; }
        .button:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; opacity: 0.7; }
        .button-accent { background: linear-gradient(45deg, #ffb703, #fb8500); }
        .button-outline { background: #fff; color: var(--primary-color); border: 2px solid var(--border-color); box-shadow: none; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .button-outline:active { background-color: #f8f9fa; }

        input[type="text"], input[type="number"], input[type="date"], input[type="file"], .form-group select, textarea { width: 100%; padding: 12px; font-size: 1rem; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 12px; transition: border-color 0.2s, box-shadow 0.2s; font-family: inherit; }
        textarea { line-height: 1.5; }
        input:focus, .form-group select:focus, textarea:focus { outline: none; border-color: var(--secondary-color); box-shadow: 0 0 0 2px rgba(10, 147, 150, 0.2); }
        
        .search-bar { position: relative; }
        .search-bar input { padding-left: 40px; border-radius: 50px; }
        .search-bar svg { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #999; width: 20px; height: 20px; }
        
        .filter-bar { display: flex; gap: 15px; align-items: center; padding: 10px; background-color: #ffffffcc; backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); border-radius: var(--border-radius); margin: -5px -5px 15px -5px; position: sticky; top: 5px; z-index: 50; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .filter-bar .search-bar { flex: 2; margin-bottom: 0; }
        .filter-bar .form-group { flex: 1.5; margin-bottom: 0; }
        .filter-bar input, .filter-bar select { margin-bottom: 0; }
        .filter-bar select { border-radius: 50px; }

        .between-date-filter {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            padding: 10px;
            background-color: #fff;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            box-shadow: var(--card-shadow);
        }
        .between-date-filter .date-btn {
            flex: 1;
            min-width: 120px;
            padding: 10px;
            font-size: 0.9rem;
            background-color: #f8f9fa;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: var(--primary-color);
            font-weight: 500;
            transition: all 0.2s ease;
        }
        .between-date-filter .date-btn.has-date {
            background-color: var(--light-bg);
            border-color: var(--secondary-color);
        }
        .between-date-filter .date-btn svg {
            width: 18px;
            height: 18px;
            stroke: var(--secondary-color);
            flex-shrink: 0;
        }
        .between-date-filter .filter-action-btn {
            padding: 10px 15px;
            font-size: 0.9rem;
            border-radius: 8px;
            flex-shrink: 0;
        }
        .between-date-filter .clear-btn {
            background: #fff;
            color: var(--danger-color);
            border: 1px solid var(--danger-color);
        }
        .between-date-filter .clear-btn:active {
            background-color: #fff1f2;
        }
        .between-date-filter .date-input {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
            border: 0;
            padding: 0;
            pointer-events: none;
        }

        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; background-color: #fff; border-radius: var(--border-radius); margin-bottom: 12px; box-shadow: var(--card-shadow); transition: transform 0.2s ease, box-shadow 0.2s, opacity 0.5s, max-height 0.5s, padding 0.5s, margin-bottom 0.5s; }
        .list-item:active { transform: scale(0.99); box-shadow: 0 2px 8px rgba(0, 95, 115, 0.1); }
        .list-item .info { flex: 1; font-size: 1rem; font-weight: 500; line-height: 1.4; margin-right: 15px; }
        .list-item-action { flex-shrink: 0; padding: 12px 15px; min-width: 110px; text-align: center; font-size: 1rem; color: var(--light-text-color); background-color: var(--secondary-color); border: none; border-radius: 8px; cursor: pointer; }

        .customer-item-container { background-color: #fff; border-radius: var(--border-radius); margin-bottom: 12px; box-shadow: var(--card-shadow); overflow: hidden; transition: box-shadow 0.2s; }
        .customer-item-header { display: flex; justify-content: space-between; align-items: center; padding: 18px 15px; cursor: pointer; }
        .customer-item-header .info { font-size: 1.1rem; font-weight: 500; }
        .customer-item-header .arrow { width: 24px; height: 24px; transition: transform 0.3s ease; }
        .customer-item-container.expanded .arrow { transform: rotate(180deg); }
        .customer-actions-panel { max-height: 0; overflow: hidden; transition: max-height 0.3s ease, padding 0.3s ease; display: flex; justify-content: space-around; background-color: #f8f9fa; border-top: 1px solid var(--border-color); }
        .customer-item-container.expanded .customer-actions-panel { max-height: 100px; padding: 12px 0; }
        .action-button { display: flex; flex-direction: column; align-items: center; gap: 5px; background: none; border: none; cursor: pointer; font-size: 0.8rem; font-weight: 500; color: var(--primary-color); padding: 5px 10px; border-radius: 8px; transition: background-color 0.2s; }
        .action-button:active { background-color: rgba(0, 95, 115, 0.1); }
        .action-button svg { width: 28px; height: 28px; stroke: var(--primary-color); stroke-width: 2; }

        .history-card { background-color: #fff; border-radius: var(--border-radius); box-shadow: var(--card-shadow); margin-bottom: 15px; overflow: hidden; transition: all 0.4s ease-out; }
        .history-card-header { padding: 15px; display: flex; justify-content: space-between; align-items: flex-start; }
        .history-card-header .info { flex-grow: 1; }
        .history-card-header .actions { display: flex; gap: 15px; flex-shrink: 0; margin-left: 10px; }
        .history-card-header p { margin: 0 0 5px; }
        .history-card-header p strong { font-weight: 600; color: var(--primary-color); }
        .history-card .date-display { font-size:0.9rem; color:#666; }
        .history-card .toggle-details { font-size: 0.9rem; font-weight: 500; color: var(--secondary-color); cursor: pointer; padding: 10px 15px; display: block; background: #f8f9fa; border-top: 1px solid #f0f0f0; }
        .history-card-body { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .history-card-body.visible { max-height: 5000px; transition: max-height 0.4s ease-in; }
        .history-item-table { width: 100%; border-collapse: collapse; }
        .history-item-table th, .history-item-table td { padding: 10px 12px; text-align: left; border-bottom: 1px solid #f0f0f0; }
        .history-item-table th { font-size: 0.8rem; color: #888; text-transform: uppercase; }
        .history-item-table td.numeric, .history-item-table th.numeric { text-align: right; white-space: nowrap; }
        .history-item-table tr:last-child td { border-bottom: none; }
        .history-item-table .col-item-name { width: 45%; white-space: normal; word-break: break-word; line-height: 1.4; }
        .history-action-btn { background: none; border: none; cursor: pointer; padding: 0; }
        .history-action-btn svg { width: 20px; height: 20px; }
        .delete-history-btn svg { stroke: var(--danger-color); }
        .print-history-btn svg { stroke: var(--secondary-color); }
        .edit-packing-slip-btn svg { stroke: var(--warning-color); }
        .history-card.removing {
            opacity: 0;
            transform: scale(0.95);
            max-height: 0 !important;
            padding-top: 0;
            padding-bottom: 0;
            margin-bottom: 0;
            overflow: hidden;
            border-top: none;
            border-bottom: none;
        }
        
        .payment-method-options { display: flex; gap: 10px; margin: 15px 0; }
        .payment-method-option { flex: 1; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.2s ease; }
        .payment-method-option.selected { background-color: var(--secondary-color); color: white; border-color: var(--secondary-color); font-weight: bold; }
        
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s ease; }
        .modal.active { display: flex; opacity: 1; }
        .modal-content { background-color: #fff; margin: auto; padding: 20px; border-radius: var(--border-radius); width: 90%; max-width: 500px; text-align: left; max-height: 80vh; display: flex; flex-direction: column; transform: scale(0.9); transition: transform 0.3s ease; }
        .modal.active .modal-content { transform: scale(1); }
        .modal-content h2 { text-align: center; margin-bottom: 15px; color: var(--primary-color); }
        .modal .button { margin-top: 10px; }
        .modal-body { overflow-y: auto; }
        .form-group { margin-bottom: 10px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        
        .modal-footer { display: flex; gap: 10px; margin-top: 20px; }
        .modal-footer .button { margin-top: 0; }
        
        #item-tiles-container { display: grid; grid-template-columns: 1fr; gap: 15px; padding-top: 15px; }
        @media (min-width: 680px) { #item-tiles-container { grid-template-columns: 1fr 1fr; } }
        .item-tile { background-color: #fff; border-radius: var(--border-radius); box-shadow: var(--card-shadow); padding: 12px; display: flex; flex-direction: column; gap: 10px; }
        .item-tile-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
        .item-tile .item-name { font-weight: 600; font-size: 1rem; word-break: break-word; }
        .item-tile .item-info-tags { font-size: 0.8rem; font-weight: 500; color: #6c757d; white-space: nowrap; }
        .item-tile .item-controls { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; align-items: flex-start; }
        .item-tile .control-cell { display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .item-tile .price-box { width: 100%; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 600; border: 1px solid var(--border-color); border-radius: 6px; background-color: #f8f9fa; cursor: pointer; transition: all 0.2s ease; }
        .item-tile .price-box.active { background-color: var(--secondary-color); color: white; border-color: var(--secondary-color); }
        .item-tile .control-label { font-size: 0.75rem; color: #555; font-weight: 500; }
        .item-tile .control-input { width: 100%; height: 40px; padding: 6px; text-align: center; font-size: 1rem; margin-bottom: 0; border-radius: 6px; -moz-appearance: textfield; }
        .item-tile .control-input::-webkit-outer-spin-button,
        .item-tile .control-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .item-tile .add-to-cart-btn { width: 100%; height: 40px; padding: 0; font-size: 0.9rem; background: var(--primary-color); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: background-color 0.2s; }
        .item-tile .add-to-cart-btn.added { background-color: var(--success-color); }

        #order-summary-list .order-item-card { display: flex; flex-direction: column; gap: 10px; align-items: stretch; padding: 12px 15px; margin-bottom: 12px; }
        #order-summary-list .item-primary-row { display: flex; justify-content: space-between; align-items: flex-start; width: 100%; }
        #order-summary-list .item-name-group { display: flex; align-items: flex-start; gap: 10px; flex-grow: 1; min-width: 0; }
        #order-summary-list .item-serial-no { font-weight: 600; color: var(--secondary-color); font-size: 1.05rem; padding-top: 2px; }
        #order-summary-list .item-name { font-weight: 600; font-size: 1.05rem; color: var(--text-color); word-break: break-word; }
        #order-summary-list .item-actions { flex-shrink: 0; margin-left: 10px; }
        #order-summary-list .item-action-btn { background: none; border: none; cursor: pointer; padding: 0; }
        #order-summary-list .item-action-btn svg { width: 22px; height: 22px; stroke-width: 2.5; }
        #order-summary-list .delete-btn svg { stroke: var(--danger-color); }
        #order-summary-list .item-details-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 100%; padding-top: 10px; border-top: 1px solid #f0f0f0; }
        #order-summary-list .detail-item { text-align: center; }
        #order-summary-list .detail-item .label { font-size: 0.8rem; color: #6c757d; margin-bottom: 2px; }
        #order-summary-list .detail-item .value { font-weight: 500; font-size: 0.95rem; }
        #order-summary-list .detail-item.total .value { font-weight: 700; color: var(--primary-color); }
        
        #order-summary-grand-total { margin-top: 20px; padding: 15px; background-color: var(--primary-color); color: white; font-size: 1.2rem; font-weight: bold; border-radius: var(--border-radius); display: flex; justify-content: space-between; align-items: center; }
        .total-margin-badge { font-size: 1rem; font-weight: 700; color: #fff; padding: 4px 10px; border-radius: 50px; }
        
        #order-summary-actions { padding: 15px; flex-shrink: 0; display: flex; flex-direction: column; gap: 10px; }

        .search-toggle-buttons { display: flex; gap: 10px; margin-top: 15px; margin-bottom: 15px; }
        .toggle-btn { flex: 1; padding: 10px; font-size: 0.9rem; font-weight: 500; text-align: center; color: var(--primary-color); background-color: #fff; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s ease; }
        .toggle-btn.active { background-color: var(--secondary-color); color: #fff; border-color: var(--secondary-color); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .search-view { display: none; }
        .search-view.active { display: block; }

        #offer-item-search-results, #offer-item-search-results-bulk, #info-salesman-item-search-results, #info-item-search-results, #packing-item-search-results { position: absolute; top: 100%; left: 0; right: 0; background: #fff; border: 1px solid var(--border-color); border-top: none; border-radius: 0 0 var(--border-radius) var(--border-radius); max-height: 250px; overflow-y: auto; z-index: 1000; box-shadow: 0 8px 16px rgba(0,0,0,0.1); }
        
        .search-result-item { padding: 12px 15px; cursor: pointer; display: flex; flex-direction: column; align-items: flex-start; border-bottom: 1px solid #f0f0f0; }
        .search-result-item:last-child { border-bottom: none; }
        .search-result-item:hover { background-color: var(--light-bg); }
        .search-result-item .item-name { font-weight: 500; width: 100%; white-space: normal; margin-bottom: 8px; font-size: 1rem; }
        .search-result-item .item-details-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; width: 100%; text-align: center; }
        .search-result-item .detail-cell .label { display: block; font-size: 0.7rem; color: #6c757d; text-transform: uppercase; margin-bottom: 2px; }
        .search-result-item .detail-cell .value { font-size: 0.85rem; font-weight: 600; }
        .search-result-item .item-p2 { color: var(--primary-color); }
        .search-result-item .item-margin.profit { color: var(--success-color); }
        .search-result-item .item-margin.loss { color: var(--danger-color); }
        
        #packing-slip-wrapper, #payment-receipt-wrapper, #payment-summary-print-wrapper, #sale-bill-wrapper { display: none; }
        #collection-report-wrapper { position: absolute; left: -9999px; top: -9999px; }
        #collection-report { background: #fff; padding: 40px; }
        
        #packing-slip-content, #sale-bill-content { font-family: 'Segoe UI', sans-serif; color: #222; padding: 0; font-size: 14px; }
        .slip-page-number { text-align: right; font-size: 0.8rem; color: #555; }
        .slip-header, .bill-header { text-align: center; margin-bottom: 10px; }
        .slip-header h2, .bill-header h2 { margin: 0; font-size: 1.8rem; color: #000; font-weight: 700; }
        .slip-header p, .bill-header p { font-size: 0.8rem; color: #555; margin: 2px 0 0; }
        .slip-details, .bill-details { display: flex; justify-content: space-between; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 2px solid #333; font-size: 0.85rem; }
        .slip-details div, .bill-details div { line-height: 1.4; }
        .slip-details div strong, .bill-details div strong { font-weight: 600; }
        .slip-table, .bill-table { width: 100%; border-collapse: collapse; }
        .slip-table th, .slip-table td, .bill-table th, .bill-table td { padding: 5px 8px; text-align: left; border-bottom: 1px solid #333; }
        .slip-table th, .bill-table th { background-color: #f2f2f2; font-weight: 600; font-size: 0.8rem; }
        .slip-table td, .bill-table td { font-size: 0.85rem; vertical-align: top; }
        .slip-table .col-item-name, .bill-table .col-item-name { width: 45%; white-space: normal; }
        .slip-table .col-qty, .slip-table .col-price, .bill-table .col-qty, .bill-table .col-price, .bill-table .col-total { text-align: right; white-space: nowrap; }
        .slip-table .col-mrp, .bill-table .col-mrp { white-space: nowrap; }
        .slip-table .price-type { font-size: 0.7em; color: #444; margin-left: 2px; }
        .slip-footer, .bill-footer { margin-top: 15px; padding-top: 10px; border-top: 2px solid #333; text-align: right; font-size: 1rem; }
        .slip-footer .sorted-by { display: inline-block; text-align: left; }
        .slip-footer .signature-line { display: block; border-bottom: 1px solid #333; width: 180px; margin-top: 25px; }
        .bill-footer div { margin-bottom: 5px; }

        .receipt-container { font-family: Calibri, sans-serif; color: black; padding: 20px; width: 100%;}
        .receipt-header { text-align: center; margin-bottom: 25px; }
        .receipt-header h2 { font-size: 2rem; font-weight: bold; margin: 0; }
        .receipt-header p { margin: 5px 0 0; font-size: 1rem; }
        .receipt-details { margin-bottom: 20px; line-height: 1.6; font-size: 1.1rem; border-top: 1px dashed #ccc; border-bottom: 1px dashed #ccc; padding: 15px 0; }
        .receipt-details p { display: flex; justify-content: space-between; margin: 8px 0; }
        .receipt-details strong { font-weight: normal; margin-right: 15px; white-space: nowrap; }
        .receipt-details span { font-weight: bold; text-align: right; }
        .receipt-details span#receipt-customer { white-space: normal; word-break: break-word; flex-shrink: 1; }
        .receipt-amount { text-align: center; margin: 30px 0; }
        .receipt-amount .amount-label { font-size: 1.1rem; color: #555; }
        .receipt-amount .amount-value { font-size: 2.5rem; font-weight: bold; color: black; }
        .receipt-footer { text-align: center; margin-top: 30px; font-size: 0.9rem; color: #777; border-top: 1px dashed #ccc; padding-top: 15px;}
        
        .dashboard-grid { display: grid; gap: 15px; grid-template-columns: 1fr; }
        .kpi-card-small { background-color: #fff; border-radius: var(--border-radius); box-shadow: var(--card-shadow); padding: 15px; text-align: center; }
        .kpi-card-small .value { font-size: 1.8rem; font-weight: 700; color: var(--primary-color); line-height: 1.2; overflow-wrap: break-word; }
        .kpi-card-small .label { font-size: 0.85rem; color: #6c757d; margin-top: 5px; }
        .data-list-card { background-color: #fff; border-radius: var(--border-radius); box-shadow: var(--card-shadow); padding: 20px; display: flex; flex-direction: column; }
        .data-list-card h3 { border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .data-list-container, .payment-summary-list { list-style: none; padding: 0; margin: 0; }
        .data-list-container { max-height: 300px; overflow-y: auto; }
        .data-list-item { display: flex; justify-content: space-between; align-items: center; gap: 10px; padding: 12px 5px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: background-color 0.2s; }
        .data-list-item:hover { background-color: var(--light-bg); }
        .data-list-item:last-child { border-bottom: none; }
        .data-list-item .item-main {
            font-weight: 600;
            white-space: normal;
            overflow: hidden;
            text-overflow: ellipsis;
            min-width: 0;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        .data-list-item .item-details { text-align: right; }
        .item-details .value-primary { font-weight: 600; color: var(--text-color); display: block; font-size: 1rem; }
        .item-details .value-secondary { font-size: 0.8rem; color: #6c757d; }
        .item-details .value-secondary .profit, .item-details .value-secondary .loss { color: var(--success-color); font-weight: 500; }
        .item-details .value-secondary .loss { color: var(--danger-color); }
        .profit { color: var(--success-color); }
        .loss { color: var(--danger-color); }
        #page-salesman-report .content, #page-customer-report .content, #page-customer-ledger .content { padding-top: 10px; }
        .report-table { width: 100%; border-collapse: collapse; }
        .report-table th, .report-table td { padding: 10px 8px; text-align: left; border-bottom: 1px solid var(--border-color); font-size: 0.9rem; }
        .report-table th { font-weight: 600; background-color: #f8f9fa; }
        .report-table td.numeric, .report-table th.numeric { text-align: right; }
        .report-header-card { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; padding: 0; background-color: transparent; border-radius: 0; margin-bottom: 20px; box-shadow: none; }
        .report-header-card > div { background-color: #fff; border-radius: var(--border-radius); box-shadow: var(--card-shadow); padding: 15px; text-align: center; }
        .report-header-card > div > .label { font-size: 0.8rem; color: #6c757d; }
        .report-header-card > div > .value { font-size: 1.2rem; font-weight: 700; color: var(--primary-color); }
        .payment-summary-list li { display: flex; justify-content: space-between; padding: 10px 5px; font-size: 1rem; border-bottom: 1px solid #f0f0f0; }
        .payment-summary-list li:last-child { border-bottom: none; }
        .payment-summary-list li strong { color: var(--primary-color); }
        .payment-summary-list .salesman-header { font-weight: 600; color: var(--secondary-color); margin-top: 15px; padding-bottom: 5px; border-bottom: 1px solid var(--border-color); }
        .payment-summary-list .salesman-breakdown li { padding-left: 20px; font-size: 0.9rem; }
        .payment-summary-list .salesman-breakdown li:last-child { font-weight: bold; }

        /* FIX: Added rule to unify admin dashboard card widths */
        #page-admin-dashboard .between-date-filter,
        #page-admin-dashboard .dashboard-grid {
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        #crm-filters { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        #crm-filters select { margin-bottom: 0; }
        #crm-customer-count { text-align: center; font-weight: 500; color: var(--primary-color); margin-bottom: 20px; }
        #crm-flyer-preview-container { text-align: center; min-height: 150px; display:flex; align-items:center; justify-content:center; border: 1px solid #eee; border-radius: 8px; margin-top: 15px; background-color: #f8f9fa; }
        #crm-flyer-preview-container img { max-width: 100%; border-radius: var(--border-radius); }
        
        #offer-builder-item-list, #crm-flyer-item-list { max-height: 250px; overflow-y: auto; margin-bottom: 20px; }
        .offer-builder-item { display: grid; grid-template-columns: 1fr auto auto; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid #f0f0f0; }
        .offer-builder-item .item-info .item-name { font-weight: 500; }
        .offer-builder-item .item-info .item-price { font-size: 0.9rem; color: #666; }
        .offer-builder-item .item-action-btn { background: none; border: none; cursor: pointer; padding: 5px; }
        .offer-builder-item .item-action-btn svg { width: 20px; height: 20px; }
        .offer-builder-item .delete-btn svg { stroke: var(--danger-color); }
        .offer-builder-item .edit-btn svg { stroke: var(--secondary-color); }

        #flyer-template-wrapper { position: absolute; left: -9999px; top: -9999px; width: 500px; }
        #flyer-content { font-family: 'Segoe UI', Roboto, sans-serif; color: #fff; padding: 30px; background-color: #65A30D; background-image: radial-gradient(circle at 10% 10%, #84CC16 0%, transparent 50%), linear-gradient(145deg, #84CC16 0%, #65A30D 100%); position: relative; overflow: hidden; }
        #flyer-content::before { content: ''; position: absolute; top: -50px; left: -50px; width: 200px; height: 200px; background: rgba(255, 255, 255, 0.05); border-radius: 50%; }
        #flyer-header { text-align: center; margin-bottom: 25px; }
        #flyer-logo { font-size: 2.8rem; font-weight: 800; margin: 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); }
        #flyer-tagline { font-size: 1rem; opacity: 0.9; }
        #flyer-offer-details { margin-bottom: 25px; }
        #flyer-headline { font-size: 2.2rem; font-weight: 800; text-align: center; color: #fff; margin-bottom: 25px; line-height: 1.3; text-shadow: 2px 2px 5px rgba(0,0,0,0.25); }
        #flyer-headline .customer-name-highlight { color: #FEFE00; }
        #flyer-item-list { list-style: none; padding: 0; margin: 0; }
        .flyer-item { background: rgba(0, 0, 0, 0.2); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 10px; padding: 15px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
        .flyer-item-name { font-size: 1.1rem; font-weight: 600; max-width: 70%; color: #27272A; }
        .flyer-item-price { font-size: 1.2rem; font-weight: 700; color: #27272A; background-color: #FEFE00; padding: 5px 12px; border-radius: 50px; }
        #flyer-footer { margin-top: 30px; text-align: center; font-size: 0.9rem; opacity: 0.8; }
        #offer-flyer-preview-container img { max-width: 100%; border-radius: 8px; }
        
        .table-responsive-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        
        .summary-totals-card { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .summary-totals-card .kpi-card-small { margin-bottom: 0; }
        .summary-totals-card .grand-total { grid-column: 1 / -1; }
        
        .summary-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .summary-table th, .summary-table td { padding: 12px 8px; text-align: left; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        .summary-table th { font-size: 0.8rem; font-weight: 600; text-transform: uppercase; color: #888; background-color: #f8f9fa; }
        .summary-table td { font-size: 0.9rem; }
        .summary-table .col-customer { width: 50%; word-break: break-word; font-weight: 500; }
        .summary-table .col-mode { width: 25%; }
        .summary-table .col-amount { width: 25%; text-align: right; font-weight: 600; color: var(--primary-color); }
        .summary-table th.col-amount { text-align: right; }

        .leaflet-container { height: 100%; width: 100%; }
        
        #location-summary-list .list-item { flex-direction: column; align-items: flex-start; gap: 8px; }
        #location-summary-list .list-item p { margin: 0; font-size: 0.95rem; color: #333; }
        #location-summary-list .list-item .button-outline { width: auto; padding: 5px 15px; font-size: 0.9rem; margin-top: 5px; }
        #location-details-list .list-item-action { background-color: transparent; border: 1px solid var(--secondary-color); color: var(--secondary-color); }

        #professional-modal .modal-content { text-align: center; }
        #professional-modal-message { font-size: 1.1rem; color: #555; margin: 20px 0; line-height: 1.5; }
        #professional-modal .modal-footer { justify-content: center; }

        #payment-summary-print-content { display: none; font-family: 'Segoe UI', 'Helvetica Neue', sans-serif; color: #000; }
        .print-header { text-align: center; margin-bottom: 25px; border-bottom: 2px solid #333; padding-bottom: 15px; }
        .print-header h2 { margin: 0; font-size: 24pt; }
        .print-header p { margin: 5px 0 0; font-size: 11pt; color: #555; }
        .print-details { display: flex; justify-content: space-between; margin-bottom: 25px; font-size: 11pt; }
        .print-table { width: 100%; border-collapse: collapse; font-size: 10pt; }
        .print-table th, .print-table td { padding: 10px; text-align: left; border-bottom: 1px solid #ccc; }
        .print-table th { background-color: #f2f2f2; font-weight: 600; }
        .print-table td.numeric, .print-table th.numeric { text-align: right; }
        .print-totals-footer { margin-top: 25px; padding-top: 15px; border-top: 2px solid #333; float: right; width: 40%; min-width: 250px; }
        .print-totals-footer div { display: flex; justify-content: space-between; font-size: 12pt; margin-bottom: 8px; }
        .print-totals-footer div.grand-total { font-weight: 700; font-size: 14pt; border-top: 1px solid #333; padding-top: 8px; }

        #product-info-display-card { margin-top: 20px; }
        #product-info-display-card h3 { font-size: 1.3rem; word-break: break-word; }
        .price-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 15px; margin-top: 15px; }
        .price-item { text-align: center; padding: 10px; background-color: #f8f9fa; border-radius: var(--border-radius); border: 1px solid var(--border-color); }
        .price-item .label { font-size: 0.9rem; font-weight: 500; color: #6c757d; }
        .price-item .value { font-size: 1.2rem; font-weight: 700; color: var(--primary-color); }
        .stock-info { text-align: center; margin-top: 20px; font-weight: 500; }

        #edit-slip-item-list .order-item-card { display: flex; flex-direction: column; gap: 10px; margin-bottom: 12px; background: #fff; border-radius: var(--border-radius); padding: 15px; box-shadow: var(--card-shadow); }
        #edit-slip-item-list .item-primary-row { display: flex; justify-content: space-between; align-items: center; }
        #edit-slip-item-list .item-name { font-weight: 600; flex-grow: 1; margin-right: 10px; }
        #edit-slip-item-list .delete-btn svg { stroke: var(--danger-color); }
        #edit-slip-item-list .item-controls-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; align-items: center; padding-top: 10px; margin-top: 10px; border-top: 1px solid #f0f0f0; }
        #edit-slip-item-list .form-group { margin-bottom: 0; }
        #edit-slip-item-list .form-group label { font-size: 0.8rem; color: #555; font-weight: 500; margin-bottom: 4px; }
        #edit-slip-item-list input { margin-bottom: 0; padding: 10px; }
        
        #outstanding-list-container .list-item { display: grid; grid-template-columns: 1fr auto auto; gap: 15px; align-items: center; padding: 12px 15px; }
        #outstanding-list-container .outstanding-balance { font-size: 1rem; font-weight: 600; padding: 10px 15px; border-radius: 8px; border: 1px solid var(--border-color); text-align: right; background-color: #f8f9fa; -moz-appearance: textfield; max-width: 120px; }
        #outstanding-list-container .outstanding-balance::-webkit-outer-spin-button,
        #outstanding-list-container .outstanding-balance::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        #outstanding-list-container .outstanding-balance:focus { outline: none; border-color: var(--secondary-color); box-shadow: 0 0 0 2px rgba(10, 147, 150, 0.2); }
        #outstanding-list-container .reminder-btn { background: none; border: none; cursor: pointer; padding: 5px; }
        #outstanding-list-container .reminder-btn svg { width: 28px; height: 28px; stroke: var(--secondary-color); stroke-width: 2; }
        
        .toast-notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--success-color);
            color: white;
            padding: 12px 25px;
            border-radius: 50px;
            font-size: 0.9rem;
            font-weight: 500;
            z-index: 9999;
            opacity: 0;
            transition: opacity 0.3s ease, bottom 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .toast-notification.show {
            opacity: 1;
            bottom: 30px;
        }

        /* NEW LOGIN SCREEN STYLES */
        :root {
            --light-bg: #f0f8ff; 
            --text-color-light: #576c7f;
            --border-radius-lg: 24px;
            --border-radius-md: 16px;
            
            /* Accent Colors for Roles */
            --sales-accent: #ffb703;
            --sales-accent-light: #fffbeb;
            --admin-accent: #8e44ad;
            --admin-accent-light: #f3e5f5;
            --packing-accent: #27ae60;
            --packing-accent-light: #e8f5e9;
            --loading-accent: #2980b9;
            --loading-accent-light: #eaf2f8;
            --delivery-accent: #e67e22;
            --delivery-accent-light: #fdf3e6;
            --billing-accent: #7f8c8d;
            --billing-accent-light: #f2f4f4;
            --accounts-accent: #2c3e50;
            --accounts-accent-light: #e5e7e9;
        }

        @keyframes float {
            0% { transform: translateY(0px) translateX(0px); }
            50% { transform: translateY(-20px) translateX(10px); }
            100% { transform: translateY(0px) translateX(0px); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #page-login {
            background: linear-gradient(135deg, #e0f7fa 0%, #f0f8ff 100%);
        }

        .login-page-container {
            position: relative;
            display: grid;
            grid-template-rows: 1fr auto 1fr; 
            height: 100%;
            padding: 20px;
            box-sizing: border-box;
            z-index: 1;
        }
        
        .login-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            animation: fadeIn 0.8s ease-out;
            grid-row: 2; 
        }
        
        .login-header {
            text-align: center;
            grid-row: 1; 
            align-self: end; 
            animation: fadeIn 0.8s ease-out;
            margin-bottom: 80px; /* Increased margin */
        }
        .login-header h1 {
            font-size: clamp(1.5rem, 5vw, 2.2rem);
            font-weight: 700;
            color: var(--primary-color);
            letter-spacing: -0.5px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.05);
            margin: 0;
        }
        .login-header p {
            margin-top: 12px;
            font-size: clamp(1rem, 3vw, 1.2rem);
            color: var(--text-color-light);
            font-weight: 500;
            letter-spacing: 0.5px;
        }
       
        .select-role-button {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 150px;
            height: 150px;
            background: linear-gradient(145deg, #ffffff, #e6f7fa);
            border: 1px solid rgba(0, 95, 115, 0.1);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--card-shadow);
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
            gap: 12px;
        }

        .select-role-button:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 30px rgba(0, 95, 115, 0.2);
        }

        .select-role-button:active {
            transform: translateY(-2px) scale(0.97);
        }

        .select-role-button svg {
            width: 48px;
            height: 48px;
            stroke: var(--primary-color);
            stroke-width: 1.5;
        }

        .select-role-button span {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .role-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 31, 38, 0.6);
            display: none; /* Changed from opacity */
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            backdrop-filter: blur(8px);
            z-index: 1000;
            padding: 20px;
            box-sizing: border-box;
        }

        .role-modal.active {
            display: flex; /* Changed from opacity */
            opacity: 1;
            pointer-events: auto;
        }

        .role-modal-content {
            background-color: #fff;
            padding: 20px;
            border-radius: var(--border-radius-lg);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.25);
            width: 100%;
            max-width: 380px;
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .role-modal.active .role-modal-content {
            transform: scale(1);
        }

        .role-modal-content h2 {
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 1.4rem;
            color: var(--primary-color);
            text-align: center;
        }

        .role-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .role-tile {
            aspect-ratio: 1 / 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: var(--border-radius-md);
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            text-decoration: none;
            color: var(--text-color);
            gap: 5px;
            padding: 5px;
            box-sizing: border-box;
        }
        
        .role-tile.dummy {
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .role-tile:not(.dummy):active {
            transform: scale(0.95);
        }
        
        .role-tile svg {
            width: 32px;
            height: 32px;
            stroke-width: 1.5;
            color: var(--primary-color);
            transition: all 0.2s ease;
        }
        
        .role-tile:hover:not(.dummy) svg {
            transform: scale(1.1);
        }
        
        .role-tile span {
            font-weight: 500;
            font-size: 0.8rem;
            text-align: center;
        }

        /* Subtle borders for roles */
        .role-tile[data-role="UNNI"], .role-tile[data-role="RIYAS"] { border-color: var(--sales-accent); }
        .role-tile[data-role="SUNNY"] { border-color: var(--packing-accent); }
        .role-tile[data-role="ADMIN"] { border-color: var(--admin-accent); }
        .role-tile.dummy[data-role="SHAJU"] { border-color: var(--loading-accent); }
        .role-tile.dummy[data-role="BENNY"] { border-color: var(--delivery-accent); }
        .role-tile.dummy[data-role="ANISHAD"] { border-color: var(--billing-accent); }
        .role-tile.dummy[data-role="NANDU"] { border-color: var(--accounts-accent); }
        
        .role-tile[data-role="UNNI"]:hover,
        .role-tile[data-role="RIYAS"]:hover {
            background-color: var(--sales-accent-light);
            transform: translateY(-4px);
            box-shadow: 0 4px 10px rgba(255, 183, 3, 0.2);
        }
        .role-tile[data-role="UNNI"]:hover svg,
        .role-tile[data-role="RIYAS"]:hover svg {
            color: #c28802;
        }
        
        .role-tile[data-role="SUNNY"]:hover {
            background-color: var(--packing-accent-light);
            box-shadow: 0 4px 10px rgba(39, 174, 96, 0.2);
             transform: translateY(-4px);
        }
        .role-tile[data-role="SUNNY"]:hover svg {
            color: #1e8449;
        }

        .role-tile[data-role="ADMIN"]:hover {
            background-color: var(--admin-accent-light);
            box-shadow: 0 4px 10px rgba(142, 68, 173, 0.2);
             transform: translateY(-4px);
        }
        .role-tile[data-role="ADMIN"]:hover svg {
            color: #6c3483;
        }

        .role-tile[data-role="SHAJU"]:hover {
            background-color: var(--loading-accent-light);
        }
        .role-tile[data-role="SHAJU"]:hover svg { color: #21618c; }

        .role-tile[data-role="BENNY"]:hover {
            background-color: var(--delivery-accent-light);
        }
        .role-tile[data-role="BENNY"]:hover svg { color: #b9671b; }

        .role-tile[data-role="ANISHAD"]:hover {
            background-color: var(--billing-accent-light);
        }
        .role-tile[data-role="ANISHAD"]:hover svg { color: #626567; }

        .role-tile[data-role="NANDU"]:hover {
            background-color: var(--accounts-accent-light);
        }
        .role-tile[data-role="NANDU"]:hover svg { color: #1c2833; }
        
        .workflow-container {
            grid-row: 3;
            align-self: center;
            display: flex;
            gap: 30px;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.8s ease-out 0.2s;
            animation-fill-mode: backwards;
        }
        
        .workflow-container svg {
            width: 32px;
            height: 32px;
            stroke-width: 1.5;
            opacity: 0.7;
        }
        #icon-sales { color: var(--sales-accent); }
        #icon-billing { color: var(--billing-accent); }
        #icon-packing { color: var(--packing-accent); }
        #icon-delivery { color: var(--delivery-accent); }
        #icon-accounts { color: var(--accounts-accent); }

        /* SUNNY - Packer UI Enhancements */
        #packing-item-list .list-item {
            gap: 15px;
            align-items: center;
        }
        #packing-item-list .list-item input[type="checkbox"] {
            width: 24px;
            height: 24px;
            flex-shrink: 0;
        }
        #packing-item-list .list-item .info {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex-grow: 1;
            margin: 0;
        }
        .packing-item-name {
            font-weight: 600;
            font-size: 1rem;
        }
        .packing-item-details {
            font-size: 0.85rem;
            color: #666;
            font-weight: 500;
        }

        /* CUSTOMER LEDGER STYLES - FINAL MOBILE FIX */
        .ledger-table {
            table-layout: fixed; /* This is the key property */
            width: 100%;
            border-collapse: collapse;
        }
        .ledger-table th, .ledger-table td {
            padding: 9px 4px; /* Optimized padding */
            font-size: 0.8rem;
            vertical-align: middle;
            text-align: left;
            white-space: nowrap; /* Prevent wrapping in most cells */
            overflow: hidden;
            text-overflow: ellipsis; /* Add ellipsis if content is still too long */
        }
        .ledger-table th.numeric, .ledger-table td.numeric {
            text-align: right;
        }
        .ledger-table th {
            font-size: 0.7rem; /* Further reduced header font */
            text-transform: uppercase;
        }
        /* Explicit Column Widths */
        .ledger-table th:nth-child(1), .ledger-table td:nth-child(1) { width: 22%; } /* Date */
        .ledger-table th:nth-child(2), .ledger-table td:nth-child(2) {
            width: 35%; /* Particulars */
            white-space: normal; /* Allow this specific column to wrap if needed */
            word-break: break-word;
        }
        .ledger-table th:nth-child(3), .ledger-table td:nth-child(3) { width: 21.5%; } /* Debit */
        .ledger-table th:nth-child(4), .ledger-table td:nth-child(4) { width: 21.5%; } /* Credit */

        .ledger-sale-row { cursor: pointer; }
        .ledger-sale-row:hover { background-color: var(--light-bg); }
        .ledger-details-row { display: none; }
        .ledger-details-row.visible { display: table-row; }
        .ledger-details-cell { padding: 10px 15px !important; background-color: #f8f9fa; }
        .ledger-item-list { list-style: none; padding: 0 0 10px 0; margin: 0; font-size: 0.8rem; }
        .ledger-item-list li { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #eee; }
        .ledger-item-list li:last-child { border-bottom: none; }
        .ledger-item-name { max-width: 70%; }
        .ledger-item-qty { font-weight: 500; white-space: nowrap; }
        .ledger-details-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .ledger-details-header h4 { margin: 0; font-size: 1rem; color: var(--primary-color); }


        @media (max-width: 767px) {
            #page-admin-dashboard .content { padding: 10px; }
            .dashboard-grid { grid-template-columns: 1fr; }
            .summary-totals-card { grid-template-columns: 1fr; }
            #page-outstanding-balances .filter-bar { flex-direction: column; align-items: stretch; }
        }
        @media (min-width: 768px) {
            .report-header-card > div > .label { font-size: 0.9rem; }
            .report-header-card > div > .value { font-size: 1.5rem; }
        }

        @media print {
            @page { size: A4; margin: 20mm; }
            body, html { background: #fff !important; height: auto !important; overflow: visible !important; }
            body > * { display: none !important; }
            body.printing-packing-slip #packing-slip-wrapper,
            body.printing-receipt #payment-receipt-wrapper,
            body.printing-summary #payment-summary-print-wrapper,
            body.printing-sale-bill #sale-bill-wrapper { display: block !important; position: static !important; }
            #payment-summary-print-content { display: block !important; }
            .slip-page-break, .bill-page-break { page-break-before: always; }
            .slip-table thead, .bill-table thead { display: table-header-group; }
            .slip-table tr, .bill-table tr { page-break-inside: avoid; }
        }
    </style>
</head>
<body>

    <div id="page-login" class="page active">
        <div class="login-page-container">
            <header class="login-header">
                <h1>MF SALES & OPERATION</h1>
                <p>Wholesale. Simplified.</p>
            </header>
            <div class="login-box">
                <button class="select-role-button" id="open-role-modal">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7" rx="1"></rect><rect x="14" y="3" width="7" height="7" rx="1"></rect><rect x="14" y="14" width="7" height="7" rx="1"></rect><rect x="3" y="14" width="7" height="7" rx="1"></rect></svg>
                    <span>Select Role</span>
                </button>
            </div>
            <div class="workflow-container">
                <svg id="icon-sales" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                <svg id="icon-billing" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="9" y1="15" x2="15" y2="15"></line></svg>
                <svg id="icon-packing" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
                <svg id="icon-delivery" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="3" width="15" height="13"></rect><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon><circle cx="5.5" cy="18.5" r="2.5"></circle><circle cx="18.5" cy="18.5" r="2.5"></circle></svg>
                <svg id="icon-accounts" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
            </div>
        </div>
    
        <div class="role-modal" id="role-modal">
            <div class="role-modal-content">
                <h2>Select Your Role</h2>
                <div class="role-grid">
                    <!-- Row 1: Active Roles -->
                    <button class="role-tile" data-role="UNNI">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                        <span>UNNI</span>
                    </button>
                    <button class="role-tile" data-role="RIYAS">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                        <span>RIYAS</span>
                    </button>
                    <button class="role-tile" data-role="SUNNY">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
                        <span>SUNNY</span>
                    </button>
                    <button class="role-tile" data-role="ADMIN">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="21" x2="4" y2="14"></line><line x1="4" y1="10" x2="4" y2="3"></line><line x1="12" y1="21" x2="12" y2="12"></line><line x1="12" y1="8" x2="12" y2="3"></line><line x1="20" y1="21" x2="20" y2="16"></line><line x1="20" y1="12" x2="20" y2="3"></line><line x1="1" y1="14" x2="7" y2="14"></line><line x1="9" y1="8" x2="15" y2="8"></line><line x1="17" y1="16" x2="23" y2="16"></line></svg>
                        <span>ADMIN</span>
                    </button>
                    <!-- Row 2 (Dummy Roles) -->
                    <div class="role-tile dummy" data-role="SHAJU">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>
                        <span>SHAJU</span>
                    </div>
                    <div class="role-tile dummy" data-role="BENNY">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="3" width="15" height="13"></rect><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon><circle cx="5.5" cy="18.5" r="2.5"></circle><circle cx="18.5" cy="18.5" r="2.5"></circle></svg>
                        <span>BENNY</span>
                    </div>
                     <div class="role-tile dummy" data-role="ANISHAD">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="9" y1="15" x2="15" y2="15"></line></svg>
                        <span>ANISHAD</span>
                    </div>
                     <div class="role-tile dummy" data-role="NANDU">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                        <span>NANDU</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="page-main-view" class="page">
        <div class="header">
            <button class="icon-button" id="logout-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg>
            </button>
            <h1 id="main-view-header">Customers</h1>
            <div class="header-actions">
                <button class="icon-button" id="product-info-icon-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>
                </button>
                 <button class="icon-button" id="pending-balance-btn" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                </button>
                <button class="icon-button" id="packed-orders-btn" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                </button>
                <button class="icon-button" id="history-icon-btn">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></svg>
                </button>
                <button class="icon-button" id="settings-icon-btn" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06-.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                </button>
            </div>
        </div>
        <div class="content">
            <div id="customer-view">
                <div class="filter-bar">
                    <div class="search-bar">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                        <input type="text" id="customer-search-input" placeholder="Search customers...">
                    </div>
                    <div class="form-group">
                        <select id="customer-route-filter">
                            <option value="ALL">All Routes</option>
                        </select>
                    </div>
                </div>
                <div id="customer-list-container"></div>
            </div>
            <div id="payment-view" style="display:none;">
                 <div class="filter-bar">
                    <div class="search-bar">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                        <input type="text" id="payment-customer-search-input" placeholder="Search customers...">
                    </div>
                     <div class="form-group">
                        <select id="payment-route-filter">
                            <option value="ALL">All Routes</option>
                        </select>
                    </div>
                </div>
                <div id="payment-customer-list-container"></div>
            </div>
        </div>
        <div id="footer" class="footer">
            <button class="footer-button active" id="orders-tab-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                <span>Customers</span>
            </button>
            <button class="footer-button" id="payments-tab-btn">
                 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
                <span>Payments</span>
            </button>
        </div>
    </div>

    <div id="page-order" class="page">
        <div class="header">
            <button class="icon-button" id="back-to-customers-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <h1 id="order-customer-name">New Order</h1>
            <div class="header-actions">
                <button class="icon-button" id="cart-icon-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg>
                    <span id="cart-item-count" style="display: none;">0</span>
                </button>
            </div>
        </div>
        <div class="content">
            <div class="card">
                <div class="search-toggle-buttons">
                    <button class="toggle-btn active" data-search-type="salesman">Salesman List</button>
                    <button class="toggle-btn" data-search-type="master">Master List</button>
                </div>
                <div id="salesman-search-view" class="search-view active">
                    <div class="search-bar">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                        <input type="text" id="salesman-item-search-input" placeholder="Search salesman list...">
                    </div>
                </div>
                <div id="master-search-view" class="search-view">
                     <div class="search-bar">
                         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                        <input type="text" id="item-search-input" placeholder="Search all items...">
                    </div>
                </div>
            </div>
            <div id="item-tiles-container"></div>
        </div>
    </div>
    
    <div id="page-order-summary" class="page">
        <div class="header">
            <button class="icon-button" id="back-to-order-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <h1 id="order-summary-header">Order Summary</h1>
            <div class="icon-button" style="width: 24px;"></div>
        </div>
        <div class="content">
            <h3 style="margin-bottom: 10px;">Current Order</h3>
            <div id="order-summary-list"></div>
            <div id="order-summary-grand-total"></div>
        </div>
        <div id="order-summary-actions">
            <button id="save-update-slip-btn" class="button">Save Packing Slip</button>
        </div>
    </div>

    <div id="page-payment" class="page">
        <div class="header">
             <button class="icon-button" id="back-to-main-btn-payment">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <h1 id="payment-customer-name">Collect Payment</h1>
            <div class="icon-button" style="width: 24px;"></div>
        </div>
        <div class="content">
            <div class="card">
                <input type="number" id="payment-amount" placeholder="Enter Amount" min="0">
                <div class="payment-method-options">
                    <div class="payment-method-option selected" data-method="Cash">Cash</div>
                    <div class="payment-method-option" data-method="UPI">UPI</div>
                </div>
                <button id="confirm-payment-btn" class="button">Confirm Payment</button>
                <div id="payment-actions-container" style="display: none; flex-direction: row; gap: 10px; margin-top: 10px;">
                    <button id="print-receipt-btn" class="button button-outline" style="margin: 0; flex: 1;">Print Receipt</button>
                    <button id="share-receipt-btn" class="button button-outline" style="margin: 0; flex: 1;">Share Receipt</button>
                </div>
            </div>
        </div>
    </div>

    <div id="page-order-history" class="page">
        <div class="header">
             <button class="icon-button" id="back-to-main-btn-order-history">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <h1>Packing Slip History</h1>
            <div class="icon-button" style="width: 24px;"></div>
        </div>
        <div class="content">
            <div id="order-history-date-filter" class="between-date-filter">
                <input type="date" class="date-input start-date-input">
                <button class="date-btn start-date-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                    <span class="date-label">Start Date</span>
                </button>
                <input type="date" class="date-input end-date-input">
                <button class="date-btn end-date-btn">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                    <span class="date-label">End Date</span>
                </button>
                <button class="filter-action-btn clear-btn">Clear</button>
            </div>
            <div id="order-history-list"></div>
        </div>
    </div>
    
    <div id="page-payment-history" class="page">
        <div class="header">
             <button class="icon-button" id="back-to-main-btn-payment-history">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <h1>Payment History</h1>
            <div class="icon-button" style="width: 24px;"></div>
        </div>
        <div class="content">
            <button id="view-collection-summary-btn" class="button" style="margin-bottom: 20px;">View Collection Summary</button>
            <div id="payment-history-date-filter" class="between-date-filter">
                <input type="date" class="date-input start-date-input">
                <button class="date-btn start-date-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                    <span class="date-label">Start Date</span>
                </button>
                <input type="date" class="date-input end-date-input">
                <button class="date-btn end-date-btn">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                    <span class="date-label">End Date</span>
                </button>
                <button class="filter-action-btn clear-btn">Clear</button>
            </div>
            <div id="payment-history-list"></div>
        </div>
    </div>
    
    <div id="page-outstanding-balances" class="page">
        <div class="header">
            <button class="icon-button" id="back-to-main-from-outstanding-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <h1>Pending Balances</h1>
            <div class="icon-button" style="width: 24px;"></div>
        </div>
        <div class="content">
            <div class="filter-bar">
                <div class="search-bar">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    <input type="text" id="outstanding-search-input" placeholder="Search customers...">
                </div>
                <div class="form-group">
                    <select id="outstanding-route-filter">
                        <option value="ALL">All Routes</option>
                    </select>
                </div>
                <button id="outstanding-sort-btn" class="button button-outline" style="margin: 0; flex: 1; min-width: 150px; padding: 10px; font-size: 0.9rem;">Sort by Amount</button>
            </div>
            <div class="card">
                <div class="kpi-card-small" style="padding: 20px; box-shadow: none; border: 1px solid var(--border-color);">
                    <div id="total-outstanding-value" class="value" style="color: var(--danger-color);"></div>
                    <div class="label">Total Outstanding Balance</div>
                </div>
            </div>
            <div id="outstanding-list-container"></div>
        </div>
    </div>

    <div id="page-payment-summary" class="page">
        <div class="header">
             <button class="icon-button" id="back-to-payment-history-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <h1>Collection Summary <span id="summary-date-range" style="font-size: 0.9rem; font-weight: 400; opacity: 0.8;"></span></h1>
            <div class="header-actions">
                 <button class="icon-button" id="print-summary-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
                </button>
            </div>
        </div>
        <div class="content" id="payment-summary-content"></div>
    </div>
    
    <div id="page-customer-profile" class="page">
        <div class="header">
             <button class="icon-button" data-action="back-to-main">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <h1 id="customer-profile-name">Customer Profile</h1>
            <div class="icon-button" style="width: 24px;"></div>
        </div>
        <div class="content" id="customer-profile-content"></div>
    </div>

    <div id="page-customer-ledger" class="page">
        <div class="header">
             <button class="icon-button" data-action="back-to-main">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <h1 id="customer-ledger-name">Customer Ledger</h1>
            <div class="icon-button" style="width: 24px;"></div>
        </div>
        <div class="content" id="customer-ledger-content">
        </div>
    </div>

    <div id="page-product-info" class="page">
        <div class="header">
             <button class="icon-button" id="back-to-main-from-info-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <h1>Product Info</h1>
            <div class="icon-button" style="width: 24px;"></div>
        </div>
        <div class="content">
            <div class="card">
                <h3>Search Item</h3>
                <div class="search-toggle-buttons">
                    <button class="toggle-btn active" data-search-type="info-salesman">Salesman List</button>
                    <button class="toggle-btn" data-search-type="info-master">Master List</button>
                </div>
                <div id="info-salesman-search-view" class="search-view active">
                    <div style="position: relative;">
                        <div class="search-bar">
                             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                            <input type="text" id="info-salesman-item-search-input" placeholder="Search salesman list...">
                        </div>
                        <div id="info-salesman-item-search-results"></div>
                    </div>
                </div>
                <div id="info-master-search-view" class="search-view">
                    <div style="position: relative;">
                        <div class="search-bar">
                             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                            <input type="text" id="info-item-search-input" placeholder="Search all items...">
                        </div>
                        <div id="info-item-search-results"></div>
                    </div>
                </div>
            </div>
            <div id="product-info-display-card" class="card" style="display: none;"></div>
        </div>
    </div>


    <div id="page-settings" class="page">
        <div class="header">
            <button class="icon-button" id="back-from-settings-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <h1>Manage Data</h1>
            <div class="icon-button" style="width: 24px;"></div>
        </div>
        <div class="content">
            <div class="card">
                <h3>Upload New Data</h3>
                <p style="margin-bottom: 15px; font-style: italic; color: #555;">Uploading will replace existing data.</p>
                <div class="file-upload-wrapper"><div class="file-upload-area"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg><p>Upload Customer CSV</p><input type="file" id="customer-file-upload" accept=".csv"></div></div>
                 <div class="file-upload-wrapper"><div class="file-upload-area"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg><p>Upload Item (Master) CSV</p><input type="file" id="item-file-upload" accept=".csv"></div></div>
                 <div class="file-upload-wrapper"><div class="file-upload-area"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg><p>Upload Salesman Item List CSV</p><input type="file" id="salesman-item-file-upload" accept=".csv"></div></div>
            </div>
            <div class="card">
                <h3>Edit Existing Data</h3>
                <button class="button button-outline" id="edit-customers-btn" style="margin-bottom: 10px;"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>Edit Customers</button>
                <button class="button button-outline" id="edit-items-btn"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>Edit Items</button>
            </div>
        </div>
    </div>

    <div id="page-edit-data" class="page">
        <div class="header">
            <button class="icon-button" id="back-to-settings-btn">
                 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <h1 id="edit-data-header">Edit</h1>
            <div class="icon-button" style="width: 24px;"></div>
        </div>
        <div class="content">
            <div class="search-bar"><input type="text" id="edit-data-search" placeholder="Search..."></div>
            <div id="edit-data-list"></div>
        </div>
    </div>

    <div id="page-admin-dashboard" class="page">
        <div class="header">
            <button class="icon-button" id="admin-logout-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg>
            </button>
            <h1>Admin Dashboard</h1>
            <div class="header-actions">
                 <button class="icon-button" id="admin-settings-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06-.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                </button>
            </div>
        </div>
        <div class="content">
            <div id="admin-date-filter" class="between-date-filter">
                <input type="date" class="date-input start-date-input">
                <button class="date-btn start-date-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                    <span class="date-label">Start Date</span>
                </button>
                <input type="date" class="date-input end-date-input">
                <button class="date-btn end-date-btn">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                    <span class="date-label">End Date</span>
                </button>
                <button class="filter-action-btn clear-btn">Clear</button>
            </div>
            <div id="admin-dashboard-content"></div>
        </div>
    </div>

    <div id="page-edit-packing-slip" class="page">
        <div class="header">
            <button class="icon-button" id="back-to-history-from-edit-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <h1 id="edit-packing-slip-header">Edit Packing Slip</h1>
            <div class="icon-button" style="width: 24px;"></div>
        </div>
        <div class="content">
            <div class="card">
                <h3>Add Item</h3>
                <div class="search-bar">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    <input type="text" id="edit-slip-item-search-input" placeholder="Search all items...">
                    <div id="edit-slip-item-search-results"></div>
                </div>
            </div>
            <h3 style="margin-bottom: 10px;">Current Items</h3>
            <div id="edit-slip-item-list"></div>
            <div id="edit-slip-grand-total" style="margin-top: 20px; padding: 15px; background-color: var(--primary-color); color: white; font-size: 1.2rem; font-weight: bold; border-radius: var(--border-radius); display: flex; justify-content: space-between; align-items: center;"></div>
        </div>
        <div style="padding: 20px; flex-shrink: 0; display: flex; gap: 10px;">
            <button id="save-packing-slip-btn" class="button" style="flex: 1; margin:0;">Save Changes</button>
        </div>
    </div>

    <div id="page-location-report" class="page">
        <div class="header">
            <button class="icon-button" id="back-to-admin-from-location-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <h1>Location Report</h1>
            <div class="icon-button" style="width: 24px;"></div>
        </div>
        <div class="content" id="location-report-content"></div>
    </div>
    
    <div id="page-salesman-report" class="page">
        <div class="header">
            <button class="icon-button" id="back-to-admin-dashboard-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <h1 id="salesman-report-header">Salesman Report</h1>
            <div class="icon-button" style="width: 24px;"></div>
        </div>
        <div class="content" id="salesman-report-content"></div>
    </div>

    <div id="page-customer-report" class="page">
        <div class="header">
            <button class="icon-button" id="back-to-salesman-report-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <h1 id="customer-report-header">Customer Report</h1>
            <div class="icon-button" style="width: 24px;"></div>
        </div>
        <div class="content" id="customer-report-content"></div>
    </div>

    <div id="page-crm" class="page">
        <div class="header">
            <button class="icon-button" id="back-to-admin-from-crm-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <h1>Bulk Messaging (CRM)</h1>
            <div class="icon-button" style="width: 24px;"></div>
        </div>
        <div class="content">
            <div class="card">
                <h3>1. Target Customers</h3>
                <div id="crm-filters">
                    <div class="form-group"><label for="crm-salesman-filter">Filter by Salesman</label><select id="crm-salesman-filter"><option value="ALL">All Salesmen</option></select></div>
                    <div class="form-group"><label for="crm-route-filter">Filter by Route</label><select id="crm-route-filter"><option value="ALL">All Routes</option></select></div>
                </div>
                <div id="crm-customer-count"></div>
            </div>
             <div class="card">
                <h3>2. Build Your Flyer</h3>
                <div id="crm-flyer-builder-content">
                    <div class="form-group"><label for="crm-flyer-headline">Flyer Headline</label><input type="text" id="crm-flyer-headline" placeholder="e.g., Weekend Super Sale!"></div>
                    <hr style="border: 1px solid #f0f0f0; margin: 20px 0;">
                    <h4 style="margin-bottom:10px;">Add Items to Offer</h4>
                    <div id="crm-flyer-item-list"></div>
                    <div id="offer-item-search-container-bulk" style="position: relative;"><input type="text" id="offer-item-search-input-bulk" placeholder="Search for products..."><div id="offer-item-search-results-bulk"></div></div>
                </div>
                <div id="crm-flyer-preview-container"><p style="color:#888;">Flyer preview will appear here.</p></div>
            </div>
             <button class="button" id="generate-bulk-flyer-btn">Generate Flyer Preview</button>
             <button class="button button-accent" id="share-bulk-flyer-btn" style="display:none; margin-top:10px;">Share Flyer with Customers</button>
        </div>
    </div>
    
    <div id="page-packer-home" class="page">
        <div class="header">
            <button class="icon-button" id="packer-logout-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg>
            </button>
            <h1>Pending Orders</h1>
            <div class="header-actions">
                <button class="icon-button" id="packer-history-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></svg>
                </button>
            </div>
        </div>
        <div class="content">
            <div id="packer-date-filter" class="between-date-filter">
                <input type="date" class="date-input start-date-input">
                <button class="date-btn start-date-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                    <span class="date-label">Start Date</span>
                </button>
                <input type="date" class="date-input end-date-input">
                <button class="date-btn end-date-btn">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                    <span class="date-label">End Date</span>
                </button>
                <button class="filter-action-btn clear-btn">Clear</button>
            </div>
            <div id="packer-order-list"></div>
        </div>
    </div>

    <div id="page-packing-interface" class="page">
        <div class="header">
            <button class="icon-button" id="back-to-packer-home-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <h1 id="packing-order-customer">Packing Order</h1>
        </div>
        <div class="content">
            <div class="card">
                <h3>Add Product</h3>
                <div class="search-bar">
                    <input type="text" id="packing-item-search" placeholder="Search for an item...">
                    <div id="packing-item-search-results"></div>
                </div>
            </div>
            <div id="packing-item-list"></div>
        </div>
        <div style="padding: 15px;">
            <button id="confirm-packing-btn" class="button">Confirm Packing</button>
        </div>
    </div>

    <div id="page-packer-history" class="page">
        <div class="header">
            <button class="icon-button" id="back-to-packer-home-from-history-btn">
                 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <h1>Packing History</h1>
        </div>
        <div class="content">
            <div id="packer-history-list"></div>
        </div>
    </div>
    
    <div id="page-packed-orders" class="page">
        <div class="header">
            <button class="icon-button" id="back-to-main-from-packed-orders-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <h1>Packed Orders</h1>
        </div>
        <div class="content">
            <div id="packed-orders-list"></div>
        </div>
    </div>


    <!-- Hidden elements for generation -->
    <div id="packing-slip-wrapper"><div id="packing-slip-content"></div></div>
    <div id="sale-bill-wrapper"><div id="sale-bill-content"></div></div>
    <div id="payment-receipt-wrapper"><div class="receipt-container"><div class="receipt-header"><h2 id="receipt-title">Payment Receipt</h2><p>MF BIGMARKET</p></div><div class="receipt-details"><p><strong>Date:</strong><span id="receipt-date"></span></p><p><strong>Salesman:</strong><span id="receipt-salesman"></span></p><p><strong>Customer:</strong><span id="receipt-customer"></span></p><p id="receipt-method-container"><strong>Pay Method:</strong><span id="receipt-method"></span></p></div><div class="receipt-amount"><div id="receipt-amount-label" class="amount-label">Amount Received</div><div class="amount-value" id="receipt-amount"></div></div><div class="receipt-footer">Thank you for your business!<br>For queries, contact: 9961195050</div></div></div>
    <div id="collection-report-wrapper"><div id="collection-report"><div class="report-header"><h2>MF BIGMARKET</h2><p>Daily Collection Report</p></div><div class="report-details"><div id="report-salesman"></div><div id="report-date"></div></div><table class="report-table"><thead><tr><th>CUSTOMER</th><th class="col-method">MODE</th><th class="col-amount">AMOUNT</th></tr></thead><tbody id="report-table-body"></tbody></table><div class="report-footer"><div id="report-totals"></div><div class="grand-total" id="report-grand-total"></div></div></div></div>
    <div id="flyer-template-wrapper"></div>
    <div id="payment-summary-print-wrapper"><div id="payment-summary-print-content"><div class="print-header"><h2>MF BIGMARKET</h2><p>Collection Summary Report</p></div><div class="print-details"><div id="print-summary-salesman"></div><div id="print-summary-daterange"></div></div><table class="print-table"><thead><tr><th>Date & Time</th><th>Customer</th><th>Mode</th><th class="numeric">Amount</th></tr></thead><tbody id="print-summary-table-body"></tbody></table><div class="print-totals-footer"><div><span>Total Cash:</span> <span id="print-summary-cash"></span></div><div><span>Total UPI:</span> <span id="print-summary-upi"></span></div><div class="grand-total"><span>Grand Total:</span> <span id="print-summary-grandtotal"></span></div></div></div></div>
    <div id="offer-modal" class="modal"><div class="modal-content"><h2 id="offer-modal-title">Flyer Builder</h2><div class="modal-body" id="offer-modal-body"></div><div class="modal-footer"><button class="button button-outline" id="close-offer-modal-btn">Cancel</button><button class="button" id="generate-flyer-btn">Generate Flyer</button><button class="button button-accent" id="share-flyer-btn" style="display:none;">Share Flyer</button></div></div></div>
    <div id="edit-modal" class="modal"><div class="modal-content"><h2 id="edit-modal-title">Edit</h2><div class="modal-body" id="edit-modal-body"></div><div class="modal-footer"><button class="button button-outline" id="close-edit-modal-btn">Cancel</button><button class="button" id="save-edit-btn">Save Changes</button></div></div></div>
    <div id="professional-modal" class="modal"><div class="modal-content"><h2 id="professional-modal-title">Success</h2><div class="modal-body"><p id="professional-modal-message">Your action was successful.</p></div><div class="modal-footer"><button class="button" id="professional-modal-close-btn">Close</button></div></div></div>


<script type="module">
    document.addEventListener('DOMContentLoaded', () => {
        if (!window.firebaseDB || !window.firebaseTools) {
            document.body.innerHTML = `<div style="padding: 20px; text-align: center;"><h1>Initialization Error</h1><p>Could not connect to the database. Please check your internet connection and Firebase configuration.</p></div>`;
            return;
        }
        
        const getDefaultDateRange = () => {
            const now = new Date();
            const toYYYYMMDD = (d) => d.toISOString().split('T')[0];
            const today = toYYYYMMDD(now);
            return { startDate: today, endDate: today };
        };

        const { startDate, endDate } = getDefaultDateRange();
        
        let appState = {
            salesman: null, customer: null, items: [], customers: [],
            salesmanItems: [], 
            orders: {}, payments: {}, customerCarts: {},
            editingPackingSlipId: null,
            currentPayment: {}, currentView: 'customers',
            editing: { type: null, id: null },
            reporting: { 
                salesman: null, 
                customer: null, 
                startDate: startDate, 
                endDate: endDate 
            },
            shareableFlyerBlob: null,
            bulkFlyerBlob: null,
            flyerBuilder: { items: [], editingIndex: null },
            currentOrderLocation: null,
            outstandingUpdateTimeout: null,
            outstandingSort: 'default', // 'default', 'desc', 'asc'
            packingOrder: null,
        };

        const { getDocs, collection, doc, setDoc, onSnapshot, deleteDoc, writeBatch, query, updateDoc, deleteField } = window.firebaseTools;
        const db = window.firebaseDB;

        const getActiveCart = () => {
            if (!appState.customer || !appState.customer.id) return [];
            if (!appState.customerCarts[appState.customer.id]) {
                appState.customerCarts[appState.customer.id] = [];
            }
            return appState.customerCarts[appState.customer.id];
        };
       
        const showPage = (pageId) => { 
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); 
            const page = document.getElementById(pageId);
            if(page) {
                page.classList.add('active'); 
                if (page.querySelector('.between-date-filter')) {
                    updateFilterUI(page.querySelector('.between-date-filter').id);
                }
            }
        };
        const formatCurrency = (v) => new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(v);
        const formatPreciseCurrency = (v) => new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(v);
        
        const formatDateForDisplay = (dateString) => {
            if (!dateString) return null;
            const date = new Date(dateString);
            const userTimezoneOffset = date.getTimezoneOffset() * 60000;
            const correctedDate = new Date(date.getTime() + userTimezoneOffset);
            return correctedDate.toLocaleDateString('en-GB'); // DD/MM/YYYY format
        };
        
        const formatDDMMYY = (dateString) => {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: '2-digit' }); 
        };

        const formatDDMMYYYYTime = (dateString) => {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleString('en-GB', { timeZone: 'Asia/Kolkata' }).replace(',', ''); // e.g., 09/09/2025 11:23:45
        };
        
        const createSearchResultItemHTML = (i) => {
            const margin = i.CostRate > 0 ? (((i.Price2 - i.CostRate) / i.CostRate) * 100) : 0;
            const marginClass = margin >= 0 ? 'profit' : 'loss';
            const stockColor = i.Clstock > 10 ? 'var(--success-color)' : (i.Clstock > 0 ? 'var(--warning-color)' : 'var(--danger-color)');

            return `
                <div class="search-result-item" data-item-code="${i.Code}">
                    <div class="item-name">${i.ItemName}</div>
                    <div class="item-details-grid">
                        <div class="detail-cell"><span class="label">P2</span><span class="value item-p2">${formatPreciseCurrency(i.Price2)}</span></div>
                        <div class="detail-cell"><span class="label">MRP</span><span class="value">${formatPreciseCurrency(i.Mrp)}</span></div>
                        <div class="detail-cell"><span class="label">Margin</span><span class="value item-margin ${marginClass}">${margin.toFixed(1)}%</span></div>
                        <div class="detail-cell"><span class="label">Stock</span><span class="value item-stock" style="color: ${stockColor};">${i.Clstock}</span></div>
                    </div>
                </div>`;
        };

        const showProfessionalModal = (title, message, onCloseCallback) => {
            const modal = document.getElementById('professional-modal');
            document.getElementById('professional-modal-title').textContent = title;
            document.getElementById('professional-modal-message').textContent = message;
            const closeBtn = document.getElementById('professional-modal-close-btn');
            const closeModal = () => {
                modal.classList.remove('active');
                if (onCloseCallback && typeof onCloseCallback === 'function') onCloseCallback();
            };
            closeBtn.addEventListener('click', closeModal, { once: true });
            modal.classList.add('active');
        };
        
        const showToast = (message) => {
            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('show');
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, 2000);
            }, 10);
        };


        const getCurrentLocation = () => {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) return reject(new Error("Geolocation is not supported."));
                navigator.geolocation.getCurrentPosition(
                    (pos) => resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude }),
                    (err) => reject(new Error(`Location Error (${err.code}): ${err.message}`)),
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            });
        };

        const setupRealtimeListeners = () => {
            onSnapshot(collection(db, "customers"), (snapshot) => { 
                appState.customers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); 
                if(appState.salesman !== 'ADMIN' && appState.salesman !== 'SUNNY') renderCurrentView();
                if(document.getElementById('page-outstanding-balances').classList.contains('active')) renderOutstandingBalancesPage();
            });
            onSnapshot(collection(db, "items"), (snapshot) => { 
                appState.items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); 
                if (appState.salesman === 'ADMIN' && document.getElementById('page-admin-dashboard').classList.contains('active')) renderAdminDashboard();
            });
            onSnapshot(doc(db, "salesman_items", "sharedList"), (docSnap) => {
                appState.salesmanItems = docSnap.exists() ? docSnap.data().itemNames || [] : [];
            });
            onSnapshot(query(collection(db, "orders")), (snapshot) => { 
                appState.orders = {}; 
                snapshot.docs.forEach(doc => { 
                    const order = { id: doc.id, ...doc.data() }; 
                    if (!appState.orders[order.salesman]) appState.orders[order.salesman] = []; 
                    appState.orders[order.salesman].push(order); 
                }); 
                if (document.getElementById('page-order-history').classList.contains('active')) renderHistoryTabs();
                 if (document.getElementById('page-packed-orders').classList.contains('active')) renderPackedOrders();
                if (appState.salesman === 'ADMIN' && document.getElementById('page-admin-dashboard').classList.contains('active')) renderAdminDashboard();
                if (appState.salesman === 'SUNNY' && document.getElementById('page-packer-home').classList.contains('active')) renderPackerHome();
                if (appState.salesman === 'SUNNY' && document.getElementById('page-packer-history').classList.contains('active')) renderPackerHistory();
                 if (document.getElementById('page-customer-ledger').classList.contains('active')) renderCustomerLedger();
            });
            onSnapshot(query(collection(db, "payments")), (snapshot) => { 
                appState.payments = {}; 
                snapshot.docs.forEach(doc => { const payment = { id: doc.id, ...doc.data() }; if (!appState.payments[payment.salesman]) appState.payments[payment.salesman] = []; appState.payments[payment.salesman].push(payment); });
                if (appState.salesman === 'ADMIN' && document.getElementById('page-admin-dashboard').classList.contains('active')) renderAdminDashboard();
                 if (document.getElementById('page-payment-history').classList.contains('active')) renderHistoryTabs();
                 if (document.getElementById('page-customer-ledger').classList.contains('active')) renderCustomerLedger();
            });
        };

        const populateRoutes = (selectElementId) => {
            const salesmanCustomers = appState.customers.filter(c => c.Salesman && c.Salesman.toUpperCase() === appState.salesman);
            const routes = [...new Set(salesmanCustomers.map(c => c.Route).filter(Boolean))].sort();
            const routeFilter = document.getElementById(selectElementId);
            const currentRoute = routeFilter.value; 
            routeFilter.innerHTML = `<option value="ALL">All Routes</option>` + routes.map(r => `<option value="${r}" ${currentRoute === r ? 'selected' : ''}>${r}</option>`).join('');
        };

        const renderCustomerList = () => {
            const container = document.getElementById('customer-list-container');
            populateRoutes('customer-route-filter');
            const searchFilter = document.getElementById('customer-search-input').value.toLowerCase();
            const selectedRoute = document.getElementById('customer-route-filter').value;
            const filteredCustomers = appState.customers.filter(c => c.Salesman && c.Salesman.toUpperCase() === appState.salesman && (c.Customer || '').toLowerCase().includes(searchFilter) && (selectedRoute === 'ALL' || c.Route === selectedRoute));
            if (filteredCustomers.length === 0) { container.innerHTML = `<div class="card" style="text-align: center;">No customers found.</div>`; return; }
            container.innerHTML = filteredCustomers.map(c => `
                <div class="customer-item-container" data-customer='${JSON.stringify(c)}'>
                    <div class="customer-item-header">
                        <span class="info">${c.Customer}</span>
                        <svg class="arrow" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                    </div>
                    <div class="customer-actions-panel">
                        <button class="action-button" data-action="profile"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg><span>Profile</span></button>
                        <button class="action-button" data-action="ledger"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg><span>Ledger</span></button>
                        <button class="action-button" data-action="order"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg><span>Order</span></button>
                        <button class="action-button" data-action="offer"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg><span>Offer</span></button>
                    </div>
                </div>`).join('');
        };
        const renderPaymentCustomerList = () => {
const container = document.getElementById('payment-customer-list-container');
            populateRoutes('payment-route-filter');
            const searchFilter = document.getElementById('payment-customer-search-input').value.toLowerCase();
            const selectedRoute = document.getElementById('payment-route-filter').value;
            const filteredCustomers = appState.customers.filter(c => c.Salesman && c.Salesman.toUpperCase() === appState.salesman && (c.Customer || '').toLowerCase().includes(searchFilter) && (selectedRoute === 'ALL' || c.Route === selectedRoute));
            if (filteredCustomers.length === 0) { container.innerHTML = `<div class="card" style="text-align: center;">No customers found.</div>`; return; }
            container.innerHTML = filteredCustomers.map(c => `
                <div class="list-item">
                    <div class="info">
                        ${c.Customer}
                        <div style="font-size: 0.9rem; color: var(--danger-color); font-weight: 500; margin-top: 4px;">
                           Bal: ${formatCurrency(c.Outstanding || 0)}
                        </div>
                    </div>
                    <button class="list-item-action" data-customer='${JSON.stringify(c)}'>Collect</button>
                </div>`).join('');
        };
        
        const renderSalesmanItemSearchResults = (filter = '', resultsContainerId) => {
            const cont = document.getElementById(resultsContainerId);
            if (!filter) { cont.innerHTML = ''; return; }
            const lowerFilter = filter.toLowerCase();
            const filteredNames = appState.salesmanItems.filter(name => name.toLowerCase().includes(lowerFilter));
            const searchResults = filteredNames.map(name => appState.items.find(item => item.ItemName === name)).filter(Boolean);
            cont.innerHTML = searchResults.slice(0, 50).map(i => createSearchResultItemHTML(i)).join('');
        };
        const renderItemSearchResults = (filter = '', resultsContainerId) => { 
            const cont = document.getElementById(resultsContainerId); 
            if (!filter) { cont.innerHTML = ''; return; }
            const nameFilter = item => (item.ItemName || '').toLowerCase().includes(filter.toLowerCase());
            cont.innerHTML = appState.items.filter(i => nameFilter(i)).slice(0, 50).map(i => createSearchResultItemHTML(i)).join('');
        };

        const renderItemTiles = (itemsToDisplay) => {
            const container = document.getElementById('item-tiles-container');
            if (!itemsToDisplay || itemsToDisplay.length === 0) {
                container.innerHTML = `<p class="card" style="text-align:center; grid-column: 1 / -1;">No items found matching your search.</p>`;
                return;
            }
            
            const stockColor = (stock) => stock > 10 ? 'var(--success-color)' : (stock > 0 ? 'var(--warning-color)' : 'var(--danger-color)');
            const formatShortCurrency = (v) => `₹${Number(v).toFixed(2)}`;

            container.innerHTML = itemsToDisplay.map(item => `
                <div class="item-tile" data-item-code="${item.Code}">
                    <div class="item-tile-header">
                        <div class="item-name">${item.ItemName}</div>
                        <div class="item-info-tags"><span>MRP: ${formatPreciseCurrency(item.Mrp)}</span> | <span style="color: ${stockColor(item.Clstock)};">Stock: ${item.Clstock}</span></div>
                    </div>
                    <div class="item-controls">
                        <div class="control-cell"><button class="price-box active" data-price-type="p2">${formatShortCurrency(item.Price2)}</button><span class="control-label">P2</span></div>
                        <div class="control-cell"><button class="price-box" data-price-type="p3">${formatShortCurrency(item.Price3)}</button><span class="control-label">P3</span></div>
                        <div class="control-cell"><input type="number" class="control-input custom-price-input" placeholder="Price" min="0"><span class="control-label">Custom</span></div>
                        <div class="control-cell"><input type="number" class="control-input quantity-input" min="0.01" step="any"><span class="control-label">QTY</span></div>
                        <div class="control-cell"><button class="add-to-cart-btn">Add</button><span class="control-label">&nbsp;</span></div>
                    </div>
                </div>`).join('');
        };

        const renderPreviousItemsAsTiles = () => {
            const customerOrders = (appState.orders[appState.salesman] || []).filter(o => o.customer.Customer === appState.customer.Customer);
            if (customerOrders.length === 0) {
                document.getElementById('item-tiles-container').innerHTML = `<p class="card" style="text-align:center;">No previous items for this customer. Use search to find items.</p>`;
                return;
            }
            
            const uniqueItemCodes = new Set();
            customerOrders.forEach(order => { (order.items || []).forEach(item => uniqueItemCodes.add(item.item.Code)); });
            const previousItems = [...uniqueItemCodes].map(code => appState.items.find(i => i.Code == code)).filter(Boolean);
            renderItemTiles(previousItems);
        };

        const updateCartBadge = () => {
            const badge = document.getElementById('cart-item-count');
            const cart = getActiveCart();
            const count = cart.length;
            badge.style.display = count > 0 ? 'block' : 'none';
            badge.textContent = count;
        };

        const renderOrderSummaryPage = () => { 
            const listCont = document.getElementById('order-summary-list');
            const totalCont = document.getElementById('order-summary-grand-total'); 
            const cart = getActiveCart();
            let grandTotalRevenue = 0, grandTotalCost = 0;
            if (cart.length === 0) { listCont.innerHTML = '<p class="card" style="text-align:center;">Your cart is empty.</p>'; totalCont.style.display = 'none'; return; } 
            listCont.innerHTML = cart.map((o, idx) => { 
                const lineItemRevenue = o.quantity * o.sellingPrice; 
                const lineItemCost = o.quantity * (parseFloat(o.item.CostRate) || 0); 
                grandTotalRevenue += lineItemRevenue; 
                grandTotalCost += lineItemCost; 
                return `<div class="order-item-card">
                            <div class="item-primary-row">
                                <div class="item-name-group"><span class="item-serial-no">${idx + 1}.</span><div class="item-name">${o.item.ItemName}</div></div>
                                <div class="item-actions"><button class="item-action-btn delete-btn" data-index="${idx}"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button></div>
                            </div>
                            <div class="item-details-grid">
                                <div class="detail-item"><div class="label">Qty</div><div class="value">${o.quantity} ${o.item.Unit||""}</div></div>
                                <div class="detail-item"><div class="label">Price</div><div class="value">${formatPreciseCurrency(o.sellingPrice)}</div></div>
                                <div class="detail-item total"><div class="label">Total</div><div class="value">${formatPreciseCurrency(lineItemRevenue)}</div></div>
                            </div>
                        </div>`; 
            }).join(''); 
            let marginPercent = grandTotalCost > 0 ? ((grandTotalRevenue - grandTotalCost) / grandTotalCost) * 100 : 0;
            let marginBgColor = marginPercent >= 5 ? 'var(--success-color)' : marginPercent >= 4 ? 'var(--warning-color)' : 'var(--danger-color)';
            totalCont.innerHTML = `<span>Grand Total: ${formatPreciseCurrency(grandTotalRevenue)}</span><span class="total-margin-badge" style="background-color: ${marginBgColor};">${marginPercent.toFixed(2)}%</span>`;
            totalCont.style.display = 'flex'; 

            const saveUpdateBtn = document.getElementById('save-update-slip-btn');
            
            if(appState.editingPackingSlipId) {
                document.getElementById('order-summary-header').textContent = 'Edit Slip Summary';
                saveUpdateBtn.textContent = 'Update Packing Slip';
            } else {
                document.getElementById('order-summary-header').textContent = 'Order Summary';
                saveUpdateBtn.textContent = 'Save Packing Slip';
            }
        };

        const renderHistoryTabs = () => {
            const isPaymentHistory = document.getElementById('page-payment-history').classList.contains('active');
            const container = isPaymentHistory ? document.getElementById('payment-history-list') : document.getElementById('order-history-list');
            
            let historyData;
            if (isPaymentHistory) {
                historyData = appState.payments[appState.salesman] || [];
            } else {
                historyData = appState.orders[appState.salesman] || [];
            }
            
            const { start, end } = getReportDateRange();
            if (start && end) {
                historyData = historyData.filter(item => {
                    const itemDate = new Date(item.date);
                    return itemDate >= start && itemDate <= end;
                });
            }

            if (historyData.length === 0) {
                container.innerHTML = `<p class="card" style="text-align:center;">No history found for the selected dates.</p>`;
                return;
            }

            historyData.sort((a, b) => new Date(b.date) - new Date(a.date));
            const costMap = new Map(appState.items.map(i => [String(i.Code), parseFloat(i.CostRate) || 0]));

            container.innerHTML = historyData.map((item) => {
                const isOrderType = !isPaymentHistory;
                const itemCount = isOrderType && item.items ? item.items.length : 0;
                const totalText = isOrderType ? `<strong>Total:</strong> ${formatPreciseCurrency(item.total)} (${itemCount} items)` : `<strong>Amount:</strong> ${formatPreciseCurrency(item.amount)}`;
                const itemDetailsHtml = isOrderType ? (item.items || []).map(i => `<tr><td class="col-item-name">${i.item.ItemName}</td><td class="numeric">${i.quantity} ${i.item.Unit || ""}</td><td class="numeric">${formatPreciseCurrency(i.sellingPrice)}</td><td class="numeric"><strong>${formatPreciseCurrency(i.quantity * i.sellingPrice)}</strong></td></tr>`).join('') : '';

                let profitHtml = '';
                if (isOrderType && item.items) {
                    const totalCost = item.items.reduce((sum, lineItem) => {
                        const itemCost = costMap.get(String(lineItem.item.Code)) || 0;
                        return sum + (lineItem.quantity * itemCost);
                    }, 0);
                    const totalProfit = item.total - totalCost;
                    const margin = item.total > 0 ? (totalProfit / item.total) * 100 : 0;
                    const profitClass = totalProfit >= 0 ? 'profit' : 'loss';
                    profitHtml = `<p><strong>Profit:</strong> <span class="${profitClass}">${formatPreciseCurrency(totalProfit)} (${margin.toFixed(1)}%)</span></p>`;
                }

                let actionsHtml = '';
                if (isPaymentHistory) {
                     actionsHtml = `<button class="history-action-btn delete-history-btn" data-type="payments" title="Delete"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>`;
                } else { // Packing Slips
                    const isPacked = item.status === 'packed';
                    if (isPacked) {
                        actionsHtml = `
                            <button class="history-action-btn print-history-btn" title="Print Packing Slip"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg></button>
                            <span style="display:flex; align-items:center; gap: 5px; color: var(--success-color);" title="This order has been packed.">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                            </span>`;
                    } else {
                        actionsHtml = `
                            <button class="history-action-btn edit-packing-slip-btn" title="Edit Slip"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
                            <button class="history-action-btn print-history-btn" title="Print Packing Slip"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg></button>
                            <button class="history-action-btn delete-history-btn" data-type="orders" title="Delete"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>`;
                    }
                }
                
                return `<div class="history-card" data-id="${item.id}" data-type="${isPaymentHistory ? 'payments' : 'orders'}">
                            <div class="history-card-header">
                                <div class="info">
                                    <p><strong>Customer:</strong> ${item.customer.Customer}</p>
                                    <p>${totalText}</p>
                                    ${profitHtml}
                                    <p class="date-display">${formatDDMMYYYYTime(item.date)}</p>
                                </div>
                                <div class="actions">${actionsHtml}</div>
                            </div>
                            ${isOrderType ? `<div class="history-card-body" id="details-${item.id}"><div class="table-responsive-wrapper"><table class="history-item-table"><thead><tr><th class="col-item-name">Item</th><th class="numeric">Qty / Unit</th><th class="numeric">Price</th><th class="numeric">Total</th></tr></thead><tbody>${itemDetailsHtml}</tbody></table></div></div><a class="toggle-details" data-target="details-${item.id}">View Details</a>` : ""}
                        </div>`;
            }).join('');
        };
        
        const getReportDateRange = () => {
            const { startDate, endDate } = appState.reporting;
            if (!startDate && !endDate) return { start: null, end: null };

            let start, end;
            if (startDate) {
                start = new Date(startDate);
                start.setHours(0, 0, 0, 0);
            } else {
                start = new Date(0); // The beginning of time
            }

            if (endDate) {
                end = new Date(endDate);
                end.setHours(23, 59, 59, 999);
            } else {
                end = new Date(); // Now
            }

            return { start, end };
        };

        const processAdminData = () => {
            const { start, end } = getReportDateRange();
            const costMap = new Map(appState.items.map(i => [String(i.Code), parseFloat(i.CostRate) || 0]));
            
            let orders = Object.values(appState.orders).flat().filter(o => o.status === 'packed');
            let payments = Object.values(appState.payments).flat();

            if (start && end) {
                orders = orders.filter(o => { const orderDate = new Date(o.date); return orderDate >= start && orderDate <= end; });
                payments = payments.filter(p => { const paymentDate = new Date(p.date); return paymentDate >= start && paymentDate <= end; });
            }
            
            let totalRevenue = 0, totalCost = 0, totalOrders = orders.length;
            const salesBySalesman = {};
            const itemsSold = {};
            const customerSet = new Set();

            orders.forEach(order => {
                customerSet.add(order.customer.Customer);
                const salesman = order.salesman || 'N/A';
                if (!salesBySalesman[salesman]) salesBySalesman[salesman] = { revenue: 0, cost: 0, orderCount: 0 };
                salesBySalesman[salesman].orderCount++;

                const itemsToProcess = order.packedItems || order.items;

                (itemsToProcess || []).forEach(item => {
                    if (item.wasUnchecked) return; 
                    const revenue = (item.quantity || 0) * (item.sellingPrice || 0);
                    const cost = (item.quantity || 0) * (costMap.get(String(item.item.Code)) || 0);
                    
                    totalRevenue += revenue; 
                    totalCost += cost;
                    salesBySalesman[salesman].revenue += revenue; 
                    salesBySalesman[salesman].cost += cost;

                    const itemName = item.item.ItemName;
                    if (!itemsSold[itemName]) itemsSold[itemName] = { quantity: 0, revenue: 0 };
                    itemsSold[itemName].quantity += (item.quantity || 0);
                    itemsSold[itemName].revenue += revenue;
                });
            });
            
            const collectionsBySalesman = {};
            let grandTotalCash = 0, grandTotalUPI = 0;
            payments.forEach(p => {
                const salesman = p.salesman || 'N/A';
                if (!collectionsBySalesman[salesman]) collectionsBySalesman[salesman] = { cash: 0, upi: 0 };
                if (p.method === 'Cash') { collectionsBySalesman[salesman].cash += p.amount; grandTotalCash += p.amount; }
                else if (p.method === 'UPI') { collectionsBySalesman[salesman].upi += p.amount; grandTotalUPI += p.amount; }
            });

            return { totalRevenue, totalProfit: totalRevenue - totalCost, totalOrders, uniqueCustomers: customerSet.size, salesBySalesman, itemsSold: Object.entries(itemsSold).sort((a, b) => b[1].revenue - a[1].revenue), collectionsBySalesman, grandTotalCash, grandTotalUPI };
        };

        const renderAdminDashboard = () => {
            const dashboardContent = document.getElementById("admin-dashboard-content");
            const data = processAdminData();
            
            const riyasCollection = (data.collectionsBySalesman['RIYAS']?.cash || 0) + (data.collectionsBySalesman['RIYAS']?.upi || 0);
            const unniCollection = (data.collectionsBySalesman['UNNI']?.cash || 0) + (data.collectionsBySalesman['UNNI']?.upi || 0);
            const overallMargin = data.totalRevenue > 0 ? (data.totalProfit / data.totalRevenue) * 100 : 0;

            const kpiItems = [
                { title: 'Total Sales', value: formatPreciseCurrency(data.totalRevenue) },
                { title: 'RIYAS Sales', value: formatPreciseCurrency(data.salesBySalesman['RIYAS']?.revenue || 0) },
                { title: 'RIYAS Collection', value: formatPreciseCurrency(riyasCollection) },
                { title: 'UNNI Sales', value: formatPreciseCurrency(data.salesBySalesman['UNNI']?.revenue || 0) },
                { title: 'UNNI Collection', value: formatPreciseCurrency(unniCollection) },
                { title: 'Overall Profit', value: formatPreciseCurrency(data.totalProfit), class: data.totalProfit >= 0 ? 'profit' : 'loss'},
                { title: 'Overall Margin', value: `${overallMargin.toFixed(1)}%`, class: overallMargin >= 0 ? 'profit' : 'loss' },
                { title: 'Unique Customers', value: data.uniqueCustomers }
            ];

            const kpiListHtml = kpiItems.map(item => `
                <li class="data-list-item" style="cursor:default;">
                    <div class="item-main">${item.title}</div>
                    <div class="item-details"><span class="value-primary ${item.class || ''}">${item.value}</span></div>
                </li>
            `).join('');
            
            const kpiCardHtml = `<div class="data-list-card"><h3>Key Performance Indicators</h3><ul class="data-list-container" style="max-height: none;">${kpiListHtml}</ul></div>`;

            const salesListHtml = Object.entries(data.salesBySalesman).sort((a, b) => b[1].revenue - a[1].revenue).map(([salesman, d]) => { const profit = d.revenue - d.cost; const margin = d.revenue > 0 ? profit / d.revenue * 100 : 0; return `<li class="data-list-item" data-salesman="${salesman}"><div class="item-main">${salesman}</div><div class="item-details"><span class="value-primary">${formatPreciseCurrency(d.revenue)}</span><span class="value-secondary"><span class="${profit >= 0 ? "profit" : "loss"}">${formatPreciseCurrency(profit)} (${margin.toFixed(1)}%)</span></span></div></li>` }).join("") || '<li style="padding: 15px 5px; text-align: center; color: #6c757d;">No sales data available.</li>';
            const itemsSoldHtml = data.itemsSold.map(([name, d]) => `<li class="data-list-item" style="cursor:default;"><div class="item-main">${name}</div><div class="item-details"><span class="value-primary">${formatPreciseCurrency(d.revenue)}</span><span class="value-secondary">Qty: ${d.quantity.toFixed(2)}</span></div></li>`).join("") || '<li style="padding: 15px 5px; text-align: center; color: #6c757d;">No item data available.</li>';
            const totalCollections = data.grandTotalCash + data.grandTotalUPI;
            const collectionsBreakdownHtml = Object.entries(data.collectionsBySalesman).map(([salesman, d]) => `<div class="salesman-header">${salesman}</div><ul class="salesman-breakdown"><li><span>Cash</span> <span>${formatPreciseCurrency(d.cash)}</span></li><li><span>UPI</span> <span>${formatPreciseCurrency(d.upi)}</span></li><li><span>Sub-Total</span> <span>${formatPreciseCurrency(d.cash + d.upi)}</span></li></ul>`).join("");
            const collectionsHtml = Object.keys(data.collectionsBySalesman).length > 0 ? collectionsBreakdownHtml : '<li style="padding: 15px 5px; text-align: center; color: #6c757d;">No collections in this period.</li>';

            const grid = dashboardContent.querySelector('.dashboard-grid');
            if (grid) grid.remove();
            
            dashboardContent.insertAdjacentHTML('beforeend', `<div class="dashboard-grid">
                ${kpiCardHtml}
                <div class="data-list-card"><h3>Sales By Salesman</h3><ul class="data-list-container">${salesListHtml}</ul></div>
                <div class="data-list-card"><h3>Items Sold</h3><ul class="data-list-container">${itemsSoldHtml}</ul></div>
                <div class="data-list-card"><h3>Collections</h3><ul class="payment-summary-list"><li><span>Total Cash</span><strong>${formatPreciseCurrency(data.grandTotalCash)}</strong></li><li><span>Total UPI</span><strong>${formatPreciseCurrency(data.grandTotalUPI)}</strong></li><li style="font-size: 1.1rem;"><span>Grand Total</span><strong>${formatPreciseCurrency(totalCollections)}</strong></li>${collectionsHtml}</ul></div>
                <div class="data-list-card"><h3>Operations</h3><button class="button button-outline" id="location-report-btn" style="margin-bottom: 10px;"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>Location Report</button><button class="button button-outline" id="crm-module-btn"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>Send Bulk Offer</button></div>
            </div>`);
        };
        
        const renderLocationReportPage = () => { 
            const contentEl = document.getElementById('location-report-content');
            const allSalesmen = ['UNNI', 'RIYAS'];
            const dateFilterHtml = `<div id="location-report-date-filter" class="between-date-filter"><input type="date" class="date-input start-date-input"><button class="date-btn start-date-btn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg><span class="date-label">Start Date</span></button><input type="date" class="date-input end-date-input"><button class="date-btn end-date-btn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg><span class="date-label">End Date</span></button><button class="filter-action-btn clear-btn">Clear</button></div>`;

            const { start, end } = getReportDateRange();
            let filteredOrders = Object.values(appState.orders).flat();
            if (start && end) {
                filteredOrders = filteredOrders.filter(o => { const orderDate = new Date(o.date); return orderDate >= start && orderDate <= end; });
            }

            let summaryHtml = '<div class="card"><h3>Last Activity Summary</h3><div id="location-summary-list">';
            allSalesmen.forEach(salesman => {
                const lastOrder = filteredOrders.filter(o => o.salesman === salesman && o.location).sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                if (lastOrder) {
                    summaryHtml += `<div class="list-item"><div class="info"><strong style="color: var(--primary-color); font-size: 1.1rem;">${salesman}</strong><p><strong>Last Order:</strong> ${lastOrder.customer.Customer} (${formatPreciseCurrency(lastOrder.total)})</p><p><strong>Time:</strong> ${formatDDMMYYYYTime(lastOrder.date)}</p></div><a href="https://www.google.com/maps?q=${lastOrder.location.lat},${lastOrder.location.lng}" target="_blank" class="button button-outline" style="width: auto; padding: 8px 15px; font-size: 0.9rem;">View Last Location</a></div>`;
                } else {
                    summaryHtml += `<div class="list-item"><strong style="color: var(--primary-color); font-size: 1.1rem;">${salesman}</strong><span>No location data found for this period.</span></div>`;
                }
            });
            summaryHtml += '</div></div>';

            const allOrdersWithLocation = filteredOrders.filter(o => o.location).sort((a, b) => new Date(b.date) - new Date(a.date));
            let detailsHtml = '<div class="card" style="margin-top: 20px;"><h3>Detailed Location Log</h3><div id="location-details-list">';
            if (allOrdersWithLocation.length > 0) {
                detailsHtml += allOrdersWithLocation.map(order => `<div class="list-item"><div class="info"><strong>${order.customer.Customer}</strong><br><small>${order.salesman} - ${formatDDMMYYYYTime(order.date)}</small></div><a href="https://www.google.com/maps?q=${order.location.lat},${order.location.lng}" target="_blank" class="list-item-action">View Map</a></div>`).join('');
            } else {
                detailsHtml += '<p style="text-align: center; padding: 20px;">No orders with location data found for this period.</p>';
            }
            detailsHtml += '</div></div>';
            contentEl.innerHTML = dateFilterHtml + summaryHtml + detailsHtml;
            setupBetweenDateFilter('location-report-date-filter', renderLocationReportPage);
            showPage('page-location-report');
        };
        
        const renderSalesmanReport = (salesman) => {
            appState.reporting.salesman = salesman;
            document.getElementById("salesman-report-header").textContent = `${salesman}'s Report`;
            const contentEl = document.getElementById("salesman-report-content");
            const costMap = new Map(appState.items.map(i => [String(i.Code), parseFloat(i.CostRate) || 0]));

            const { start, end } = getReportDateRange();
            let salesmanOrders = (appState.orders[salesman] || []).filter(o => o.status === 'packed');

            if (start && end) {
                salesmanOrders = salesmanOrders.filter(o => { const orderDate = new Date(o.date); return orderDate >= start && orderDate <= end; });
            }
            const totalOrders = salesmanOrders.length;

            const customerSales = {};
            let totalRevenue = 0, totalProfit = 0;

            salesmanOrders.forEach(order => {
                const customerName = order.customer.Customer || "Unknown";
                if (!customerSales[customerName]) customerSales[customerName] = { revenue: 0, profit: 0, orderCount: 0 };
                customerSales[customerName].orderCount++;
                
                const itemsToProcess = order.packedItems || order.items;

                (itemsToProcess || []).forEach(item => {
                     if (item.wasUnchecked) return;
                    const revenue = (item.quantity || 0) * (item.sellingPrice || 0);
                    const cost = (item.quantity || 0) * (costMap.get(String(item.item.Code)) || 0);
                    const profit = revenue - cost;

                    customerSales[customerName].revenue += revenue;
                    customerSales[customerName].profit += profit;
                    totalRevenue += revenue;
                    totalProfit += profit;
                });
            });
            const customerListHtml = Object.entries(customerSales).sort((a, b) => b[1].revenue - a[1].revenue).map(([customerName, data]) => `<li class="data-list-item" data-customer="${customerName}"><div class="item-main">${customerName}</div><div class="item-details"><span class="value-primary">${formatPreciseCurrency(data.revenue)}</span><span class="value-secondary"><span class="${data.profit >= 0 ? "profit" : "loss"}">${formatPreciseCurrency(data.profit)} (${(data.revenue > 0 ? (data.profit / data.revenue) * 100 : 0).toFixed(1)}%)</span></span></div></li>`).join('');
            const overallMargin = totalRevenue > 0 ? (totalProfit / totalRevenue) * 100 : 0;
            
            contentEl.innerHTML = `
                <div class="report-header-card">
                    <div><div class="label">Total Revenue</div><div class="value">${formatPreciseCurrency(totalRevenue)}</div></div>
                    <div><div class="label">Total Orders</div><div class="value">${totalOrders}</div></div>
                    <div><div class="label">Total Profit</div><div class="value ${totalProfit >= 0 ? "profit" : "loss"}">${formatPreciseCurrency(totalProfit)}</div></div>
                    <div><div class="label">Profit Margin</div><div class="value ${overallMargin >= 0 ? "profit" : "loss"}">${overallMargin.toFixed(1)}%</div></div>
                </div>
                <div class="data-list-card">
                    <h3>Sales by Customer</h3>
                    <ul class="data-list-container">${customerListHtml || '<li style="text-align:center;padding:20px;">No customers found.</li>'}</ul>
                </div>`;
            showPage("page-salesman-report");
        };

        const renderCustomerReport = (salesman, customerName) => {
            appState.reporting.customer = customerName;
            document.getElementById("customer-report-header").textContent = `${customerName}`;
            const contentEl = document.getElementById("customer-report-content");
            const costMap = new Map(appState.items.map(i => [String(i.Code), parseFloat(i.CostRate) || 0]));

            const { start, end } = getReportDateRange();
            let customerOrders = (appState.orders[salesman] || []).filter(o => o.customer.Customer === customerName && o.status === 'packed');
            if (start && end) {
                customerOrders = customerOrders.filter(o => { const orderDate = new Date(o.date); return orderDate >= start && orderDate <= end; });
            }

            const itemsSold = {};
            customerOrders.forEach(order => {
                const itemsToProcess = order.packedItems || order.items;
                (itemsToProcess || []).forEach(item => {
                    if(item.wasUnchecked) return;
                    const itemName = item.item.ItemName;
                    const itemCode = String(item.item.Code);
                    if (!itemsSold[itemName]) itemsSold[itemName] = { quantity: 0, revenue: 0, cost: 0, unit: item.item.Unit };
                    itemsSold[itemName].quantity += (item.quantity || 0);
                    itemsSold[itemName].revenue += (item.quantity || 0) * (item.sellingPrice || 0);
                    itemsSold[itemName].cost += (item.quantity || 0) * (costMap.get(itemCode) || 0);
                });
            });

            let totalRevenue = 0, totalProfit = 0;
            Object.values(itemsSold).forEach(data => { totalRevenue += data.revenue; totalProfit += data.revenue - data.cost; });
            const overallMargin = totalRevenue > 0 ? (totalProfit / totalRevenue) * 100 : 0;
            const itemsTableHtml = Object.entries(itemsSold).sort((a, b) => b[1].revenue - a[1].revenue).map(([itemName, data]) => { const profit = data.revenue - data.cost; const margin = data.revenue > 0 ? (profit / data.revenue) * 100 : 0; return `<tr><td>${itemName}</td><td class="numeric">${data.quantity} ${data.unit || ""}</td><td class="numeric">${formatPreciseCurrency(data.revenue)}</td><td class="numeric ${profit >= 0 ? "profit" : "loss"}">${formatPreciseCurrency(profit)}</td><td class="numeric ${margin >= 0 ? "profit" : "loss"}">${margin.toFixed(1)}%</td></tr>`; }).join('');

            contentEl.innerHTML = `<div class="report-header-card"><div><div class="label">Total Revenue</div><div class="value">${formatPreciseCurrency(totalRevenue)}</div></div><div><div class="label">Total Profit</div><div class="value ${totalProfit >= 0 ? "profit" : "loss"}">${formatPreciseCurrency(totalProfit)}</div></div><div><div class="label">Profit Margin</div><div class="value ${overallMargin >= 0 ? "profit" : "loss"}">${overallMargin.toFixed(1)}%</div></div></div><div class="card"><div class="table-responsive-wrapper"><table class="report-table"><thead><tr><th>Product</th><th class="numeric">Qty / Unit</th><th class="numeric">Revenue</th><th class="numeric">Profit</th><th class="numeric">Margin %</th></tr></thead><tbody>${itemsTableHtml}</tbody></table></div></div>`;
            showPage("page-customer-report");
        };

        document.getElementById('admin-dashboard-content').addEventListener('click', e => { 
            const salesmanBtn = e.target.closest('.data-list-item[data-salesman]'); 
            if (salesmanBtn) { renderSalesmanReport(salesmanBtn.dataset.salesman); return; }
            const crmBtn = e.target.closest('#crm-module-btn');
            if (crmBtn) { renderCrmModule(); showPage('page-crm'); }
            const locationBtn = e.target.closest('#location-report-btn');
            if (locationBtn) { renderLocationReportPage(); }
        });

        document.getElementById('salesman-report-content').addEventListener('click', e => { const t = e.target.closest('.data-list-item[data-customer]'); t && renderCustomerReport(appState.reporting.salesman, t.dataset.customer) });
        document.getElementById('back-to-admin-dashboard-btn').addEventListener('click', () => showPage('page-admin-dashboard'));
        document.getElementById('back-to-salesman-report-btn').addEventListener('click', () => showPage('page-salesman-report'));
        document.getElementById('back-to-admin-from-location-btn').addEventListener('click', () => showPage('page-admin-dashboard'));

        const renderCustomerProfile = () => { 
            const c = appState.customer; 
            document.getElementById('customer-profile-name').textContent = c.Customer; 
            const content = document.getElementById('customer-profile-content'); 
            content.innerHTML = `
                <div class="card">
                    <p><strong>Name:</strong> ${c.Customer||'N/A'}</p>
                    <p><strong>Phone:</strong> ${c.Phone||'N/A'}</p>
                    <p><strong>Route:</strong> ${c.Route||'N/A'}</p>
                    <p><strong>Assigned Salesman:</strong> ${c.Salesman||'N/A'}</p>
                    <p><strong>Outstanding Balance:</strong> <span style="font-weight: bold; color: var(--danger-color);">${formatCurrency(c.Outstanding || 0)}</span></p>
                </div>`; 
            showPage('page-customer-profile'); 
        };
        const renderCustomerLedger = () => {
            const c = appState.customer;
            document.getElementById('customer-ledger-name').textContent = `Ledger for ${c.Customer}`;
            const container = document.getElementById('customer-ledger-content');
            
            const customerSales = (appState.orders[appState.salesman] || [])
                .filter(o => o.customer.Customer === c.Customer && o.status === 'packed');

            const customerCollections = (appState.payments[appState.salesman] || [])
                .filter(p => p.customer.Customer === c.Customer);

            const salesTransactions = customerSales.map(s => {
                const finalTotal = (s.packedItems || s.items || []).reduce((acc, item) => {
                    return item.wasUnchecked ? acc : acc + (item.quantity * item.sellingPrice);
                }, 0);
                return {
                    date: new Date(s.date),
                    type: 'Sale',
                    debit: finalTotal,
                    credit: 0,
                    id: s.id,
                    order: s 
                };
            });

            const collectionTransactions = customerCollections.map(p => ({
                date: new Date(p.date),
                type: `Collection (${p.method})`,
                debit: 0,
                credit: p.amount,
                id: p.id
            }));

            const allTransactions = [...salesTransactions, ...collectionTransactions].sort((a, b) => b.date - a.date);

            let transactionRows = '';
            allTransactions.forEach(t => {
                if (t.type === 'Sale') {
                    const itemsHtml = (t.order.packedItems || t.order.items || [])
                        .filter(i => !i.wasUnchecked)
                        .map(i => `<li><span class="ledger-item-name">${i.item.ItemName}</span> <span class="ledger-item-qty">${i.quantity} x ${formatPreciseCurrency(i.sellingPrice)}</span></li>`)
                        .join('');

                    transactionRows += `
                        <tr class="ledger-sale-row" data-target-id="details-${t.id}">
                            <td>${formatDDMMYY(t.date)}</td>
                            <td>${t.type}</td>
                            <td class="numeric">${formatPreciseCurrency(t.debit)}</td>
                            <td class="numeric">-</td>
                        </tr>
                        <tr class="ledger-details-row" id="details-${t.id}">
                            <td colspan="4" class="ledger-details-cell">
                                <div class="ledger-details-header">
                                    <h4>Sale Details</h4>
                                    <button class="icon-button print-sale-bill-btn" data-order-id="${t.id}" style="color:var(--primary-color);">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
                                    </button>
                                </div>
                                <ul class="ledger-item-list">${itemsHtml}</ul>
                            </td>
                        </tr>
                    `;
                } else {
                    transactionRows += `
                        <tr>
                            <td>${formatDDMMYY(t.date)}</td>
                            <td>${t.type}</td>
                            <td class="numeric">-</td>
                            <td class="numeric">${formatPreciseCurrency(t.credit)}</td>
                        </tr>
                    `;
                }
            });

            container.innerHTML = `
                <div class="card">
                     <div class="report-header-card">
                        <div>
                            <div class="label">Current Balance</div>
                            <div class="value" style="color: ${c.Outstanding > 0 ? 'var(--danger-color)' : 'var(--success-color)'};">
                                ${formatCurrency(c.Outstanding || 0)}
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive-wrapper">
                        <table class="report-table ledger-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Particulars</th>
                                    <th class="numeric">Debit (₹)</th>
                                    <th class="numeric">Credit (₹)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${transactionRows || `<tr><td colspan="4" style="text-align:center; padding: 20px;">No transactions found.</td></tr>`}
                            </tbody>
                        </table>
                    </div>
                </div>`;
            showPage('page-customer-ledger');
        };

        const printSaleBill = (orderId) => {
            const orderToPrint = Object.values(appState.orders).flat().find(o => o.id === orderId);
            if (!orderToPrint) { alert('Could not find order to print.'); return; }

            const itemsToPrint = (orderToPrint.packedItems || orderToPrint.items || []).filter(item => !item.wasUnchecked);
            const finalTotal = itemsToPrint.reduce((acc, item) => acc + (item.quantity * item.sellingPrice), 0);
            
            const ITEMS_PER_PAGE = 25; 
            const pages = [];
            for (let i = 0; i < itemsToPrint.length; i += ITEMS_PER_PAGE) {
                pages.push(itemsToPrint.slice(i, i + ITEMS_PER_PAGE));
            }

            let billHtml = '';
            pages.forEach((pageItems, pageIndex) => {
                const pageClass = pageIndex > 0 ? 'bill-page-break' : '';
                const tableBodyHtml = pageItems.map((item, itemIndex) => { 
                    const serialNumber = (pageIndex * ITEMS_PER_PAGE) + itemIndex + 1;
                    const total = item.quantity * item.sellingPrice;
                    return `<tr>
                                <td>${serialNumber}</td>
                                <td class="col-item-name">${item.item.ItemName}</td>
                                <td class="col-mrp">${formatPreciseCurrency(item.item.Mrp)}</td>
                                <td class="col-qty">${item.quantity} ${item.item.Unit || ''}</td>
                                <td class="col-price">${formatPreciseCurrency(item.sellingPrice)}</td>
                                <td class="col-total">${formatPreciseCurrency(total)}</td>
                            </tr>`; 
                }).join('');

                const footerHtml = pageIndex === pages.length - 1 
                    ? `<div class="bill-footer">
                           <div><strong>Grand Total: ${formatPreciseCurrency(finalTotal)}</strong></div>
                       </div>` 
                    : '';

                billHtml += `<div class="${pageClass}">
                                <div class="bill-header"><h2>MF BIGMARKET</h2><p>Sale Bill</p></div>
                                <div class="bill-details">
                                    <div><strong>Customer:</strong> ${orderToPrint.customer.Customer}<br><strong>Salesman:</strong> ${orderToPrint.salesman}</div>
                                    <div style="text-align: right;"><strong>Bill No:</strong> ${orderToPrint.id.slice(-6).toUpperCase()}<br><strong>Date:</strong> ${formatDDMMYYYY(orderToPrint.date)}</div>
                                </div>
                                <div class="slip-page-number">Page ${pageIndex + 1} of ${pages.length}</div>
                                <table class="bill-table">
                                    <thead>
                                        <tr>
                                            <th>S.No.</th>
                                            <th class="col-item-name">ITEM</th>
                                            <th class="col-mrp">MRP</th>
                                            <th class="col-qty">QTY</th>
                                            <th class="col-price">RATE</th>
                                            <th class="col-total">TOTAL</th>
                                        </tr>
                                    </thead>
                                    <tbody>${tableBodyHtml}</tbody>
                                </table>
                                ${footerHtml}
                            </div>`;
            });
            document.getElementById('sale-bill-content').innerHTML = billHtml; 
            document.body.classList.add('printing', 'printing-sale-bill'); 
            setTimeout(() => window.print(), 100);
        };
        
        // --- NEW LOGIN SCREEN LOGIC ---
        const openModalBtn = document.getElementById('open-role-modal');
        const roleModal = document.getElementById('role-modal');

        openModalBtn.addEventListener('click', () => {
            roleModal.classList.add('active');
        });

        roleModal.addEventListener('click', (e) => {
            if (e.target === roleModal) {
                roleModal.classList.remove('active');
            }
        });

        roleModal.querySelector('.role-grid').addEventListener('click', (e) => {
            const roleTile = e.target.closest('.role-tile');
            if (roleTile && !roleTile.classList.contains('dummy')) {
                const salesman = roleTile.dataset.role;
                roleModal.classList.remove('active');
                
                appState.salesman = salesman;
                localStorage.setItem('lastSalesman', salesman);
                const { startDate, endDate } = getDefaultDateRange();
                appState.reporting.startDate = startDate;
                appState.reporting.endDate = endDate;
                
                if (salesman === 'ADMIN') { 
                    document.getElementById('footer').style.display = 'none'; 
                    document.getElementById('settings-icon-btn').style.display = 'flex';
                    showPage('page-admin-dashboard'); 
                    renderAdminDashboard();
                } else if (salesman === 'SUNNY') {
                    document.getElementById('footer').style.display = 'none';
                    showPage('page-packer-home'); 
                    renderPackerHome();
                } else {
                    document.getElementById('footer').style.display = 'flex'; 
                    document.getElementById('settings-icon-btn').style.display = 'none';
                    document.getElementById('packed-orders-btn').style.display = 'flex';
                    appState.currentView = 'customers';
                    document.getElementById('orders-tab-btn').classList.add('active'); 
                    document.getElementById('payments-tab-btn').classList.remove('active');
                    showPage('page-main-view'); 
                    renderCurrentView();
                }
            }
        });

        const handleLogout = () => { 
            appState.salesman = null; 
            localStorage.removeItem('lastSalesman'); 
            appState.customerCarts = {}; 
            showPage('page-login'); 
        };

        document.getElementById('logout-btn').addEventListener('click', handleLogout);
        document.getElementById('admin-logout-btn').addEventListener('click', handleLogout);
        
        const customerView = document.getElementById('customer-view'), paymentView = document.getElementById('payment-view'), mainHeader = document.getElementById('main-view-header');
        const productInfoBtn = document.getElementById('product-info-icon-btn');
        const pendingBalanceBtn = document.getElementById('pending-balance-btn');

        const renderCurrentView = () => {
             if (appState.salesman === 'ADMIN' || appState.salesman === 'SUNNY') return; 
             if (appState.currentView === 'customers') { 
                 mainHeader.textContent = 'Customers';
                 productInfoBtn.style.display = 'flex';
                 pendingBalanceBtn.style.display = 'none';
                 document.getElementById('packed-orders-btn').style.display = 'flex';
                 renderCustomerList(); 
            } else { 
                mainHeader.textContent = 'Payments'; 
                productInfoBtn.style.display = 'none';
                pendingBalanceBtn.style.display = 'flex';
                 document.getElementById('packed-orders-btn').style.display = 'none';
                renderPaymentCustomerList();
             } 
        };
        
        document.getElementById('customer-search-input').addEventListener('input', () => renderCustomerList());
        document.getElementById('customer-route-filter').addEventListener('change', () => renderCustomerList());
        document.getElementById('payment-customer-search-input').addEventListener('input', () => renderPaymentCustomerList());
        document.getElementById('payment-route-filter').addEventListener('change', () => renderPaymentCustomerList());

        document.querySelectorAll('.footer-button').forEach(btn => btn.addEventListener('click', e => { const current = e.currentTarget; document.querySelectorAll('.footer-button').forEach(b => b.classList.remove('active')); current.classList.add('active'); customerView.style.display = 'none'; paymentView.style.display = 'none'; appState.currentView = current.id === 'orders-tab-btn' ? 'customers' : 'payments'; renderCurrentView(); if (appState.currentView === 'customers') { customerView.style.display = 'block';} else { paymentView.style.display = 'block'; } }));
        
        document.getElementById('history-icon-btn').addEventListener('click', () => {
            const isOrder = appState.currentView === 'customers';
            const pageId = isOrder ? 'page-order-history' : 'page-payment-history';
            showPage(pageId);
            renderHistoryTabs();
        });
        
        document.getElementById('product-info-icon-btn').addEventListener('click', () => showPage('page-product-info'));
        document.getElementById('pending-balance-btn').addEventListener('click', () => {
            renderOutstandingBalancesPage();
            showPage('page-outstanding-balances');
        });

        document.getElementById('back-to-main-from-info-btn').addEventListener('click', () => showPage('page-main-view'));
        document.getElementById('back-to-main-from-outstanding-btn').addEventListener('click', () => showPage('page-main-view'));


        document.getElementById('customer-list-container').addEventListener('click', async (e) => {
            const header = e.target.closest('.customer-item-header');
            const actionButton = e.target.closest('.action-button');
            if (header) { const container = header.closest('.customer-item-container'); document.querySelectorAll('.customer-item-container.expanded').forEach(item => { if (item !== container) item.classList.remove('expanded'); }); container.classList.toggle('expanded'); }
            if (actionButton) {
                const container = actionButton.closest('.customer-item-container');
                appState.customer = JSON.parse(container.dataset.customer);
                const action = actionButton.dataset.action;
                if (action === 'order') {
                    actionButton.disabled = true; 
                    try {
                        const location = await getCurrentLocation();
                        appState.currentOrderLocation = location;
                        document.getElementById('order-customer-name').textContent = `New Order: ${appState.customer.Customer}`; 
                        updateCartBadge(); renderPreviousItemsAsTiles(); showPage('page-order');
                    } catch (error) { alert(`Could not start order. Location is required.\n\nError: ${error.message}`);
                    } finally { actionButton.disabled = false; }
                } else if (action === 'profile') { renderCustomerProfile();
                } else if (action === 'ledger') { renderCustomerLedger();
                } else if (action === 'offer') { handleGenerateOffer(appState.customer); }
            }
        });
        
        document.getElementById('customer-ledger-content').addEventListener('click', e => {
            const saleRow = e.target.closest('.ledger-sale-row');
            if (saleRow) {
                const targetId = saleRow.dataset.targetId;
                const detailsRow = document.getElementById(targetId);
                if (detailsRow) {
                    detailsRow.classList.toggle('visible');
                }
            }
            
            const printBtn = e.target.closest('.print-sale-bill-btn');
            if (printBtn) {
                const orderId = printBtn.dataset.orderId;
                printSaleBill(orderId);
            }
        });
        
        document.getElementById('payment-customer-list-container').addEventListener('click', (e) => { 
            const collectBtn = e.target.closest('.list-item-action');
            if (collectBtn) { 
                appState.currentPayment.customer = JSON.parse(collectBtn.dataset.customer); 
                document.getElementById('payment-customer-name').textContent = `For ${appState.currentPayment.customer.Customer}`; 
                document.getElementById('payment-amount').value = ''; 
                document.getElementById('confirm-payment-btn').style.display = 'block'; 
                document.getElementById('payment-actions-container').style.display = 'none'; 
                showPage('page-payment'); 
            }
        });
        
        document.querySelectorAll('[data-action="back-to-main"]').forEach(btn => btn.addEventListener('click', () => showPage('page-main-view')));
        const showSettingsPage = () => showPage('page-settings');
        document.getElementById('settings-icon-btn').addEventListener('click', showSettingsPage);
        document.getElementById('admin-settings-btn').addEventListener('click', showSettingsPage);
        document.querySelectorAll('#back-to-main-btn-order-history, #back-to-main-btn-payment-history, #back-to-main-btn-payment').forEach(btn => btn.addEventListener('click', () => showPage('page-main-view')));
        
        document.getElementById('back-to-customers-btn').addEventListener('click', () => {
            const destinationPage = appState.editingPackingSlipId ? 'page-order-history' : 'page-main-view';
            if (appState.editingPackingSlipId) {
                appState.editingPackingSlipId = null;
            }
            showPage(destinationPage);
        });

        document.getElementById('back-from-settings-btn').addEventListener('click', () => { if(appState.salesman === 'ADMIN') showPage('page-admin-dashboard'); else showPage('page-main-view'); });
        document.getElementById('back-to-settings-btn').addEventListener('click', () => showPage('page-settings'));
        document.getElementById('back-to-payment-history-btn').addEventListener('click', () => showPage('page-payment-history'));
        
        const handleSearchOrToggle = () => {
            const isSalesmanList = document.querySelector('#page-order .toggle-btn[data-search-type="salesman"]').classList.contains('active');
            const searchInput = document.getElementById(isSalesmanList ? 'salesman-item-search-input' : 'item-search-input');
            const filter = searchInput.value.trim().toLowerCase();
            if (filter) {
                const sourceItems = isSalesmanList ? appState.salesmanItems.map(name => appState.items.find(i => i.ItemName === name)).filter(Boolean) : appState.items;
                const filteredItems = sourceItems.filter(item => (item.ItemName || '').toLowerCase().includes(filter));
                renderItemTiles(filteredItems);
            } else { renderPreviousItemsAsTiles(); }
        };

        document.querySelector('#page-order .search-toggle-buttons').addEventListener('click', e => { if (e.target.matches('.toggle-btn')) { const searchType = e.target.dataset.searchType; document.querySelectorAll('#page-order .toggle-btn').forEach(btn => btn.classList.remove('active')); e.target.classList.add('active'); document.querySelectorAll('#page-order .search-view').forEach(view => view.classList.remove('active')); document.getElementById(`${searchType}-search-view`).classList.add('active'); handleSearchOrToggle(); } });
        document.getElementById('salesman-item-search-input').addEventListener('input', handleSearchOrToggle);
        document.getElementById('item-search-input').addEventListener('input', handleSearchOrToggle);
        
        document.getElementById('item-tiles-container').addEventListener('click', e => {
            const priceBox = e.target.closest('.price-box');
            const addBtn = e.target.closest('.add-to-cart-btn');
            if (priceBox) { const tile = priceBox.closest('.item-tile'); tile.querySelectorAll('.price-box').forEach(box => box.classList.remove('active')); priceBox.classList.add('active'); const item = appState.items.find(i => i.Code == tile.dataset.itemCode); const priceType = priceBox.dataset.priceType; tile.querySelector('.custom-price-input').value = item[priceType === 'p2' ? 'Price2' : 'Price3']; }
            if (addBtn) {
                const tile = addBtn.closest('.item-tile'); const qtyInput = tile.querySelector('.quantity-input'); const qty = parseFloat(qtyInput.value); const customPrice = parseFloat(tile.querySelector('.custom-price-input').value);
                if (isNaN(qty) || qty <= 0) { alert('Please enter a valid quantity.'); qtyInput.focus(); return; }
                const item = appState.items.find(i => i.Code == tile.dataset.itemCode); const activePriceBox = tile.querySelector('.price-box.active');
                let price;
                if (!isNaN(customPrice) && customPrice > 0) price = customPrice;
                else if (activePriceBox) price = item[activePriceBox.dataset.priceType === 'p2' ? 'Price2' : 'Price3'];
                else { alert('Please select a price or enter a custom price.'); return; }
                getActiveCart().push({ item, quantity: qty, sellingPrice: price }); updateCartBadge();
                addBtn.textContent = 'Added!'; addBtn.classList.add('added'); setTimeout(() => { addBtn.textContent = 'Add'; addBtn.classList.remove('added'); }, 1000);
                qtyInput.value = ''; tile.querySelector('.custom-price-input').value = ''; tile.querySelectorAll('.price-box').forEach(b => b.classList.remove('active')); tile.querySelector('[data-price-type="p2"]').classList.add('active');
            }
        });
        
        document.getElementById('item-tiles-container').addEventListener('input', e => { if (e.target.matches('.custom-price-input')) e.target.closest('.item-tile').querySelectorAll('.price-box').forEach(box => box.classList.remove('active')); });
        document.getElementById('cart-icon-btn').addEventListener('click', () => { renderOrderSummaryPage(); showPage('page-order-summary'); });
        document.getElementById('back-to-order-btn').addEventListener('click', () => showPage('page-order'));
        document.getElementById('order-summary-list').addEventListener('click', e => { const deleteBtn = e.target.closest('.delete-btn'); if (deleteBtn) { getActiveCart().splice(parseInt(deleteBtn.dataset.index), 1); renderOrderSummaryPage(); updateCartBadge(); } });

        document.getElementById('save-update-slip-btn').addEventListener('click', async (e) => {
            const btn = e.currentTarget;
            const cart = getActiveCart();
            if (cart.length === 0) { alert('Cannot save an empty packing slip.'); return; }
            if (!appState.currentOrderLocation) { alert("Location data is missing. Please start the order again to capture location."); return; }

            btn.disabled = true;
            btn.textContent = 'Saving...';
            
            try {
                const total = cart.reduce((s, i) => s + (i.quantity * i.sellingPrice), 0);
                const orderData = {
                    customer: { Customer: appState.customer.Customer, Phone: appState.customer.Phone },
                    items: cart.map(i => ({ item: { ItemName: i.item.ItemName, Mrp: i.item.Mrp, Code: i.item.Code, Unit: i.item.Unit, Price1: i.item.Price1, Price2: i.item.Price2, Price3: i.item.Price3, CostRate: i.item.CostRate }, quantity: i.quantity, sellingPrice: i.sellingPrice })),
                    total,
                    salesman: appState.salesman,
                    date: new Date().toISOString(),
                    location: appState.currentOrderLocation,
                    status: 'pending' 
                };
                
                if (appState.editingPackingSlipId) {
                    await updateDoc(doc(db, "orders", appState.editingPackingSlipId), orderData);
                    showProfessionalModal('Success', 'The packing slip has been updated.', () => {
                        appState.customerCarts[appState.customer.id] = [];
                        appState.editingPackingSlipId = null;
                        updateCartBadge();
                        showPage('page-order-history');
                        renderHistoryTabs(); 
                    });
                } else {
                    await setDoc(doc(collection(db, "orders")), orderData);
                    showProfessionalModal('Success', 'The packing slip has been saved.', () => {
                        appState.customerCarts[appState.customer.id] = [];
                        updateCartBadge();
                        showPage('page-main-view');
                    });
                }
            } catch (error) {
                console.error("Error saving packing slip:", error);
                alert(`Failed to save slip. Reason: ${error.message}`);
            } finally {
                btn.disabled = false;
                appState.currentOrderLocation = null;
            }
        });

        document.querySelector('.payment-method-options').addEventListener('click', e => { if (e.target.matches('.payment-method-option')) { document.querySelectorAll('.payment-method-option').forEach(el => el.classList.remove('selected')); e.target.classList.add('selected'); } });
        
        document.getElementById('confirm-payment-btn').addEventListener('click', async (e) => {
            const btn = e.currentTarget;
            btn.disabled = true;
            btn.textContent = 'Processing...';

            const amount = parseFloat(document.getElementById('payment-amount').value);
            if (isNaN(amount) || amount <= 0) {
                alert('Please enter a valid amount.');
                btn.disabled = false;
                btn.textContent = 'Confirm Payment';
                return;
            }
            const method = document.querySelector('.payment-method-option.selected').dataset.method;
            const customerForPayment = appState.currentPayment.customer;
            
            try {
                const newPayment = {
                    customer: { Customer: customerForPayment.Customer },
                    amount,
                    method,
                    salesman: appState.salesman,
                    date: new Date().toISOString()
                };
                await setDoc(doc(collection(db, "payments")), newPayment);
                appState.currentPayment = newPayment;
                
                document.getElementById('confirm-payment-btn').style.display = 'none';
                document.getElementById('payment-actions-container').style.display = 'flex';
                showProfessionalModal('Success', 'Payment recorded. The outstanding balance will update after the next ERP sync.');

            } catch (error) {
                console.error("Error processing payment: ", error);
                alert("An error occurred. Please check your connection and try again.");
            } finally {
                btn.disabled = false;
                btn.textContent = 'Confirm Payment';
            }
        });

        const generateAndShareReceipt = async (receiptType, customer, amount) => {
             const receiptElement = document.querySelector('#payment-receipt-wrapper .receipt-container');
             if (!receiptElement) { alert('Error: Receipt element not found.'); return; }
             
             document.getElementById('receipt-date').textContent = formatDDMMYYYYTime(new Date());
             document.getElementById('receipt-salesman').textContent = appState.salesman;
             document.getElementById('receipt-customer').textContent = customer.Customer;
             document.getElementById('receipt-amount').textContent = formatCurrency(amount);

             if (receiptType === 'payment') {
                 document.getElementById('receipt-title').textContent = 'Payment Receipt';
                 document.getElementById('receipt-amount-label').textContent = 'Amount Received';
                 document.getElementById('receipt-method-container').style.display = 'flex';
                 document.getElementById('receipt-method').textContent = appState.currentPayment.method;
             } else if (receiptType === 'outstanding') {
                 document.getElementById('receipt-title').textContent = 'Outstanding Balance';
                 document.getElementById('receipt-amount-label').textContent = 'Total Amount Due';
                 document.getElementById('receipt-method-container').style.display = 'none';
             }

             const wrapper = document.getElementById('payment-receipt-wrapper');
             const originalStyles = { position: wrapper.style.position, left: wrapper.style.left, top: wrapper.style.top, display: wrapper.style.display, };
             wrapper.style.position = 'absolute'; wrapper.style.left = '-9999px'; wrapper.style.top = '-9999px'; wrapper.style.display = 'block';

             try {
                 const canvas = await html2canvas(receiptElement, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
                 const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.95));
                 const fileName = receiptType === 'payment' ? `Receipt-${customer.Customer}.jpg` : `Reminder-${customer.Customer}.jpg`;
                 const file = new File([blob], fileName, { type: 'image/jpeg' });

                 if (navigator.share && navigator.canShare({ files: [file] })) {
                    await navigator.share({ files: [file], title: `${receiptType.charAt(0).toUpperCase() + receiptType.slice(1)} for ${customer.Customer}` });
                 } else {
                     alert("Sharing not supported. Please take a screenshot to share.");
                 }
             } catch (error) {
                 console.error('Sharing failed:', error);
                 alert("Could not generate image. Please try taking a screenshot.");
             } finally {
                wrapper.style.position = originalStyles.position; wrapper.style.left = originalStyles.left; wrapper.style.top = originalStyles.top; wrapper.style.display = originalStyles.display;
             }
        };

        document.getElementById('print-receipt-btn').addEventListener('click', () => { 
            const p = appState.currentPayment; 
            document.getElementById('receipt-title').textContent = 'Payment Receipt';
            document.getElementById('receipt-amount-label').textContent = 'Amount Received';
            document.getElementById('receipt-method-container').style.display = 'flex';
            document.getElementById('receipt-method').textContent = p.method;
            document.getElementById('receipt-date').textContent = formatDDMMYYYYTime(p.date); 
            document.getElementById('receipt-salesman').textContent = appState.salesman; 
            document.getElementById('receipt-customer').textContent = p.customer.Customer; 
            document.getElementById('receipt-amount').textContent = formatPreciseCurrency(p.amount); 
            document.body.classList.add('printing', 'printing-receipt'); 
            setTimeout(() => window.print(), 100); 
        });
        
        document.getElementById('share-receipt-btn').addEventListener('click', async (e) => {
            const btn = e.currentTarget;
            btn.disabled = true;
            await generateAndShareReceipt('payment', appState.currentPayment.customer, appState.currentPayment.amount);
            btn.disabled = false;
        });


        window.onafterprint = () => { document.body.classList.remove('printing', 'printing-receipt', 'printing-packing-slip', 'printing-summary', 'printing-sale-bill'); };
        
        const printSlip = (orderId) => {
            const orderToPrint = Object.values(appState.orders).flat().find(o => o.id === orderId);
            
            if (!orderToPrint) { alert('Could not find order to print.'); return; }
            const ITEMS_PER_PAGE = 27; const pages = []; for (let i = 0; i < orderToPrint.items.length; i += ITEMS_PER_PAGE) pages.push(orderToPrint.items.slice(i, i + ITEMS_PER_PAGE));
            let slipHtml = '';
            pages.forEach((pageItems, pageIndex) => {
                const pageClass = pageIndex > 0 ? 'slip-page-break' : '';
                const tableBodyHtml = pageItems.map((item, itemIndex) => { 
                    const serialNumber = (pageIndex * ITEMS_PER_PAGE) + itemIndex + 1; 
                    let priceType = '<span class="price-type">C</span>'; 
                    if (item.item.Price2 && item.sellingPrice === item.item.Price2) priceType = '<span class="price-type">P2</span>'; 
                    else if (item.item.Price3 && item.sellingPrice === item.item.Price3) priceType = '<span class="price-type">P3</span>'; 
                    return `<tr><td>${serialNumber}</td><td class="col-mrp">${formatPreciseCurrency(item.item.Mrp)}</td><td class="col-item-name">${item.item.ItemName}</td><td class="col-qty">${item.quantity} ${item.item.Unit || ''}</td><td class="col-price">${formatPreciseCurrency(item.sellingPrice)}${priceType}</td></tr>`; 
                }).join('');
                const footerHtml = pageIndex === pages.length - 1 ? `<div class="slip-footer"><div class="sorted-by">Sorted By:<div class="signature-line"></div></div></div>` : '';
                slipHtml += `<div class="${pageClass}"><div class="slip-header"><h2>MF BIGMARKET</h2><p>Packing Slip</p></div><div class="slip-details"><div><strong>Customer:</strong> ${orderToPrint.customer.Customer}<br><strong>Salesman:</strong> ${orderToPrint.salesman}</div><div style="text-align: right;"><strong>Date:</strong> ${formatDDMMYYYY(orderToPrint.date)}<br><strong>Time:</strong> ${new Date(orderToPrint.date).toLocaleTimeString('en-GB')}</div></div><div class="slip-page-number">Page ${pageIndex + 1} of ${pages.length}</div><table class="slip-table"><thead><tr><th>S.No.</th><th class="col-mrp">MRP</th><th class="col-item-name">ITEM</th><th class="col-qty">QTY / UNIT</th><th class="col-price">PRICE</th></tr></thead><tbody>${tableBodyHtml}</tbody></table>${footerHtml}</div>`;
            });
            document.getElementById('packing-slip-content').innerHTML = slipHtml; document.body.classList.add('printing', 'printing-packing-slip'); setTimeout(() => window.print(), 100);
        };

        const handleHistoryClick = async (e) => {
            const card = e.target.closest('.history-card');
            if (!card) return;
            const id = card.dataset.id;
            const type = card.dataset.type;

            if (e.target.closest('.delete-history-btn[data-type="orders"]')) {
                if (confirm('Are you sure you want to delete this packing slip? This action cannot be undone.')) {
                    card.classList.add('removing');
                    try {
                        await deleteDoc(doc(db, "orders", id));
                        setTimeout(() => card.remove(), 400);
                    } catch (error) {
                        console.error(`Error deleting from orders:`, error);
                        showProfessionalModal('Error', `Failed to delete the entry.`);
                        card.classList.remove('removing');
                    }
                }
            } else if (e.target.closest('.delete-history-btn[data-type="payments"]')) {
                const paymentToDelete = Object.values(appState.payments).flat().find(p => p.id === id);
                if (!paymentToDelete) {
                    alert('Error: Could not find the payment to delete.');
                    return;
                }
                if (confirm(`Are you sure you want to delete this payment of ${formatCurrency(paymentToDelete.amount)}? The customer's balance will be updated on the next ERP sync.`)) {
                    card.classList.add('removing');
                    try {
                        await deleteDoc(doc(db, "payments", id));
                        showToast('Payment deleted. Balance will update after next sync.');
                        setTimeout(() => card.remove(), 400);
                    } catch (error) {
                        console.error('Error deleting payment:', error);
                        showProfessionalModal('Error', 'Failed to delete payment. Please try again.');
                        card.classList.remove('removing');
                    }
                }
            } else if (e.target.closest('.print-history-btn')) {
                printSlip(id, type);
            } else if (e.target.closest('.toggle-details')) {
                e.preventDefault();
                const target = document.getElementById(e.target.dataset.target);
                if (target) target.classList.toggle('visible');
            } else if (e.target.closest('.edit-packing-slip-btn')) {
                const orderData = (appState.orders[appState.salesman] || []).find(o => o.id === id);
                if (orderData) {
                    appState.customer = appState.customers.find(c => c.Customer === orderData.customer.Customer) || orderData.customer;
                    appState.customerCarts[appState.customer.id] = orderData.items.map(i => ({...i}));
                    appState.editingPackingSlipId = id;
                    appState.currentOrderLocation = orderData.location;
                    
                    document.getElementById('order-customer-name').textContent = `Edit Order: ${appState.customer.Customer}`;
                    updateCartBadge();
                    renderPreviousItemsAsTiles();
                    showPage('page-order');
                }
            }
        };

        document.getElementById('order-history-list').addEventListener('click', handleHistoryClick);
        document.getElementById('payment-history-list').addEventListener('click', handleHistoryClick);
        
        const updateFilterUI = (filterId) => {
            const filterContainer = document.getElementById(filterId);
            if (!filterContainer) return;
            const startBtn = filterContainer.querySelector('.start-date-btn');
            const endBtn = filterContainer.querySelector('.end-date-btn');
            const startLabel = startBtn.querySelector('.date-label');
            const endLabel = endBtn.querySelector('.date-label');
            const { startDate, endDate } = appState.reporting;

            if (startDate) {
                startLabel.textContent = formatDateForDisplay(startDate);
                startBtn.classList.add('has-date');
            } else {
                startLabel.textContent = 'Start Date';
                startBtn.classList.remove('has-date');
            }
            if (endDate) {
                endLabel.textContent = formatDateForDisplay(endDate);
                endBtn.classList.add('has-date');
            } else {
                endLabel.textContent = 'End Date';
                endBtn.classList.remove('has-date');
            }
        };

        const setupBetweenDateFilter = (filterId, renderFn) => {
            const filterContainer = document.getElementById(filterId);
            if (!filterContainer) return;
            const startBtn = filterContainer.querySelector('.start-date-btn');
            const endBtn = filterContainer.querySelector('.end-date-btn');
            const startInput = filterContainer.querySelector('.start-date-input');
            const endInput = filterContainer.querySelector('.end-date-input');
            const clearBtn = filterContainer.querySelector('.clear-btn');

            startBtn.addEventListener('click', () => startInput.showPicker ? startInput.showPicker() : startInput.click());
            endBtn.addEventListener('click', () => endInput.showPicker ? endInput.showPicker() : endInput.click());

            startInput.addEventListener('change', (e) => { appState.reporting.startDate = e.target.value; updateFilterUI(filterId); renderFn(); });
            endInput.addEventListener('change', (e) => { appState.reporting.endDate = e.target.value; updateFilterUI(filterId); renderFn(); });

            clearBtn.addEventListener('click', () => {
                appState.reporting.startDate = null; appState.reporting.endDate = null;
                startInput.value = ''; endInput.value = '';
                updateFilterUI(filterId); renderFn();
            });
        };

        setupBetweenDateFilter('admin-date-filter', renderAdminDashboard);
        setupBetweenDateFilter('order-history-date-filter', renderHistoryTabs);
        setupBetweenDateFilter('payment-history-date-filter', renderHistoryTabs);
        setupBetweenDateFilter('location-report-date-filter', renderLocationReportPage);

        const printPaymentSummary = () => {
            const { start, end } = getReportDateRange();
            let salesmanPayments = appState.payments[appState.salesman] || [];
            if (start && end) {
                salesmanPayments = salesmanPayments.filter(p => { const pDate = new Date(p.date); return pDate >= start && pDate <= end; });
            }
            let totalCash = 0, totalUPI = 0;
            salesmanPayments.forEach(p => { if (p.method === 'Cash') totalCash += p.amount; else if (p.method === 'UPI') totalUPI += p.amount; });
            const grandTotal = totalCash + totalUPI;
            salesmanPayments.sort((a, b) => new Date(a.date) - new Date(b.date));

            document.getElementById('print-summary-salesman').textContent = `Salesman: ${appState.salesman}`;
            const dateRangeText = start && end ? `Date Range: ${formatDDMMYYYY(start)} - ${formatDDMMYYYY(end)}` : 'Date Range: All Time';
            document.getElementById('print-summary-daterange').textContent = dateRangeText;
            document.getElementById('print-summary-cash').textContent = formatPreciseCurrency(totalCash);
            document.getElementById('print-summary-upi').textContent = formatPreciseCurrency(totalUPI);
            document.getElementById('print-summary-grandtotal').textContent = formatPreciseCurrency(grandTotal);

            document.getElementById('print-summary-table-body').innerHTML = salesmanPayments.map(p => `<tr><td>${formatDDMMYYYYTime(p.date)}</td><td>${p.customer.Customer}</td><td>${p.method}</td><td class="numeric">${formatPreciseCurrency(p.amount)}</td></tr>`).join('');
            document.body.classList.add('printing', 'printing-summary'); setTimeout(() => window.print(), 100);
        };

        const renderSalesmanSummaryPage = () => { 
            const { start, end } = getReportDateRange();
            let salesmanPayments = appState.payments[appState.salesman] || []; 
            if (start && end) { salesmanPayments = salesmanPayments.filter(p => { const pDate = new Date(p.date); return pDate >= start && pDate <= end; }); }
            
            let totalCash = 0, totalUPI = 0; 
            salesmanPayments.forEach(p => { if (p.method === 'Cash') totalCash += p.amount; else if (p.method === 'UPI') totalUPI += p.amount; }); 
            const grandTotal = totalCash + totalUPI; 
            salesmanPayments.sort((a, b) => new Date(b.date) - new Date(a.date)); 
            
            const transactionRowsHtml = salesmanPayments.length > 0 ? salesmanPayments.map(p => `<tr><td class="col-customer">${p.customer.Customer}</td><td class="col-mode">${p.method}</td><td class="col-amount">${formatPreciseCurrency(p.amount)}</td></tr>`).join('') : `<tr><td colspan="3" style="text-align:center; padding: 20px 0; color: #666;">No transactions in this period.</td></tr>`; 
            document.getElementById('payment-summary-content').innerHTML = `<div class="card"><div class="summary-totals-card"><div class="kpi-card-small grand-total"><div class="value">${formatPreciseCurrency(grandTotal)}</div><div class="label">Total Collected</div></div><div class="kpi-card-small"><div class="value">${formatPreciseCurrency(totalCash)}</div><div class="label">Total Cash</div></div><div class="kpi-card-small"><div class="value">${formatPreciseCurrency(totalUPI)}</div><div class="label">Total UPI</div></div></div></div><div class="card"><h3>All Transactions</h3><div class="table-responsive-wrapper"><table class="summary-table"><thead><tr><th class="col-customer">Customer</th><th class="col-mode">Mode</th><th class="col-amount">Amount</th></tr></thead><tbody>${transactionRowsHtml}</tbody></table></div></div>`; 
            
            const startLabel = appState.reporting.startDate ? formatDateForDisplay(appState.reporting.startDate) : 'Start';
            const endLabel = appState.reporting.endDate ? formatDateForDisplay(appState.reporting.endDate) : 'End';
            document.getElementById('summary-date-range').textContent = `(${startLabel} - ${endLabel})`;
            showPage('page-payment-summary'); 
        };
        document.getElementById('view-collection-summary-btn').addEventListener('click', renderSalesmanSummaryPage);
        document.getElementById('print-summary-btn').addEventListener('click', printPaymentSummary);

        const offerModal = document.getElementById('offer-modal'), offerModalBody = document.getElementById('offer-modal-body');
        const renderFlyerBuilder = () => { const customer = appState.customer; const customerOrders = (appState.orders[appState.salesman] || []).filter(o => o.customer.Customer === customer.Customer); let previouslyOrderedItemsHtml = ''; appState.flyerBuilder.items = []; if (customerOrders.length > 0) { const uniqueItemCodes = new Set(); customerOrders.forEach(order => {(order.items || []).forEach(item => uniqueItemCodes.add(item.item.Code))}); [...uniqueItemCodes].forEach(code => { const fullItem = appState.items.find(i => i.Code == code); if (fullItem) { appState.flyerBuilder.items.push({ item: fullItem, price: fullItem.Price2, isPrevious: true }); } }); if(appState.flyerBuilder.items.length > 0) { previouslyOrderedItemsHtml = `<h4 style="margin-bottom:10px;">Previously Ordered Items</h4>`; } } offerModalBody.innerHTML = `<div id="offer-flyer-preview-container"></div><div id="offer-builder-content">${previouslyOrderedItemsHtml}<div id="offer-builder-item-list"></div><hr style="border: 1px solid #f0f0f0; margin: 20px 0;"><h4 style="margin-bottom:10px;">Add New Item to Offer</h4><div id="offer-item-search-container" style="position: relative;"><input type="text" id="offer-item-search-input" placeholder="Search for products..."><div id="offer-item-search-results"></div></div></div>`; renderFlyerBuilderItems(); };
        const renderFlyerBuilderItems = () => { const listContainer = document.getElementById('offer-builder-item-list'); if (appState.flyerBuilder.items.length === 0) { listContainer.innerHTML = `<p style="text-align:center; color:#888;">No items added to flyer yet.</p>`; return; } listContainer.innerHTML = appState.flyerBuilder.items.map((flyerItem, index) => `<div class="offer-builder-item"><div class="item-info"><div class="item-name">${flyerItem.item.ItemName}</div><div class="item-price">Offer Price: ${formatPreciseCurrency(flyerItem.price)}</div></div><button class="item-action-btn edit-btn" data-index="${index}"><svg viewBox="0 0 24 24" fill="none" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button><button class="item-action-btn delete-btn" data-index="${index}"><svg viewBox="0 0 24 24" fill="none" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button></div>`).join(''); };
        const handleGenerateOffer = (customer) => { appState.customer = customer; document.getElementById('offer-modal-title').textContent = `Flyer for ${customer.Customer}`; renderFlyerBuilder(); document.getElementById('generate-flyer-btn').style.display = 'block'; document.getElementById('share-flyer-btn').style.display = 'none'; appState.shareableFlyerBlob = null; offerModal.classList.add('active'); };
        offerModalBody.addEventListener('input', e => { if(e.target.id === 'offer-item-search-input') { renderItemSearchResults(e.target.value, 'offer-item-search-results'); } });
        offerModalBody.addEventListener('click', e => { const resultItem = e.target.closest('.search-result-item'); if(resultItem) { const code = resultItem.dataset.itemCode; const fullItem = appState.items.find(i => i.Code == code); if (fullItem && !appState.flyerBuilder.items.some(fi => fi.item.Code === fullItem.Code)) { appState.flyerBuilder.items.push({ item: fullItem, price: fullItem.Price2, isPrevious: false }); renderFlyerBuilderItems(); } document.getElementById('offer-item-search-input').value = ''; document.getElementById('offer-item-search-results').innerHTML = ''; } const deleteBtn = e.target.closest('.delete-btn'); if(deleteBtn) { appState.flyerBuilder.items.splice(parseInt(deleteBtn.dataset.index), 1); renderFlyerBuilderItems(); } const editBtn = e.target.closest('.edit-btn'); if (editBtn) { const index = parseInt(editBtn.dataset.index); const flyerItem = appState.flyerBuilder.items[index]; const newPrice = prompt(`Enter new offer price for ${flyerItem.item.ItemName}:`, flyerItem.price); if (newPrice !== null && !isNaN(parseFloat(newPrice))) { flyerItem.price = parseFloat(newPrice); renderFlyerBuilderItems(); } } });
        document.getElementById('generate-flyer-btn').addEventListener('click', async () => { const generateBtn = document.getElementById('generate-flyer-btn'); const previewContainer = document.getElementById('offer-flyer-preview-container'); if (appState.flyerBuilder.items.length === 0) { alert("Please add at least one item to the flyer."); return; } generateBtn.disabled = true; generateBtn.innerHTML = 'Generating...'; previewContainer.innerHTML = '...'; document.getElementById('offer-builder-content').style.display = 'none'; let headline = `A Special Offer For <span class="customer-name-highlight">${appState.customer.Customer}</span>!`; if(appState.flyerBuilder.items.some(i => i.isPrevious)) { headline = `Your Favorites Are On Offer, <span class="customer-name-highlight">${appState.customer.Customer}</span>!`; } const itemsHtml = appState.flyerBuilder.items.map(item => `<li class="flyer-item"><span class="flyer-item-name">${item.item.ItemName}</span><span class="flyer-item-price">${formatPreciseCurrency(item.price)}</span></li>`).join(''); document.getElementById('flyer-template-wrapper').innerHTML = `<div id="flyer-content"><div id="flyer-header"><h2 id="flyer-logo">MF BIGMARKET</h2><p id="flyer-tagline">Quality Products, Delivered.</p></div><div id="flyer-offer-details"><h3 id="flyer-headline">${headline}</h3><ul id="flyer-item-list">${itemsHtml}</ul></div><div id="flyer-footer"><p>Contact your salesman to order today!</p></div></div>`; try { const canvas = await html2canvas(document.getElementById('flyer-template-wrapper'), { scale: 2, useCORS: true, backgroundColor: null }); const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.9)); appState.shareableFlyerBlob = blob; const imgEl = document.createElement('img'); imgEl.src = URL.createObjectURL(blob); previewContainer.innerHTML = ''; previewContainer.appendChild(imgEl); generateBtn.style.display = 'none'; document.getElementById('share-flyer-btn').style.display = 'block'; } catch (error) { console.error("Flyer generation error:", error); previewContainer.innerHTML = '<p style="color:red;">Error generating flyer image.</p>'; } finally { generateBtn.disabled = false; generateBtn.innerHTML = 'Generate Flyer'; } });
        document.getElementById('share-flyer-btn').addEventListener('click', async () => { const flyerBlob = appState.shareableFlyerBlob; if (!flyerBlob) { alert('Flyer image is not available.'); return; } try { const file = new File([flyerBlob], 'MF-BigMarket-Offer.jpg', { type: 'image/jpeg' }); if (navigator.share && navigator.canShare({ files: [file] })) { await navigator.share({ files: [file], title: 'Special Offer for ' + appState.customer.Customer }); } else { alert("Sharing not supported. You can save the image by long-pressing it and share manually."); } } catch (error) { console.error('Share failed:', error); alert("Could not share automatically. Please save the image and send it manually."); } });
        document.getElementById('close-offer-modal-btn').addEventListener('click', () => { offerModal.classList.remove('active'); });
        const parseCSV=(t)=>{try{const e=t.trim().split(/\r\n|\n/);if(e.length<2)return[];const n=e[0].split(",").map(t=>t.trim());return e.slice(1).map(t=>{const e={};return n.forEach((n,o)=>{let r=(t.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/)[o]||"").trim();r.startsWith('"')&&r.endsWith('"')&&(r=r.slice(1,-1)),e[n]=r}),e})}catch(t){return console.error("Error parsing CSV:",t),alert("There was an error parsing the CSV file. Please check the file for formatting issues."),null}}; const sanitizeAndStructureItems=t=>{const e=t=>parseFloat(String(t).replace(/,/g,""))||0,n=t=>String(t||"").trim();return t.map(t=>({Department:n(t.Department),Category:n(t.Category),Code:n(t.Code),ItemName:n(t.ItemName),CostRate:e(t.CostRate),Mrp:e(t.Mrp),Price1:e(t.Price1),Price2:e(t.Price2),Price3:e(t.Price3),Clstock:e(t.Clstock),Margin1:e(t.Margin1),Margin2:e(t.Margin2),Margin3:e(t.Margin3),Unit:n(t.Unit)}))}; const uploadCSV=async(t,e)=>{if(!t)return;const n=new FileReader;n.onload=async n=>{let o=parseCSV(n.target.result);if(o){if("items"===e&&(o=sanitizeAndStructureItems(o)),"customers"===e&&(!o[0]||!o[0].CustomerCode))return void alert("CSV Error: 'CustomerCode' column is missing or empty. Please add it as the first column.");if("items"===e&&(!o[0]||!o[0].Code))return void alert("CSV Error: 'Code' column is missing or empty.");try{const n=writeBatch(db);o.forEach(t=>{const o="items"===e?String(t.Code):String(t.CustomerCode);if(o){const r=doc(db,e,o);n.set(r,t)}}),await n.commit(),alert(`${o.length} ${e} records processed successfully.`)}catch(t){alert("Error uploading to database."),console.error(t)}}},n.readAsText(t)}; const uploadSalesmanItemsCSV=t=>{if(!t)return;const e=new FileReader;e.onload=async e=>{const n=parseCSV(e.target.result);if(n&&n.length>0&&n[0].ItemName){const t=n.map(t=>t.ItemName.trim()).filter(Boolean);try{const e=doc(db,"salesman_items","sharedList");await setDoc(e,{itemNames:t}),alert(`${t.length} salesman items uploaded successfully.`)}catch(t){alert("Error uploading salesman items to database."),console.error(t)}}else alert("CSV Error: 'ItemName' column not found or file is empty.")},e.readAsText(t)};
        document.getElementById('customer-file-upload').addEventListener('change', (e) => { 
uploadCSV(e.target.files[0], 'customers'); e.target.value = ''; });
        document.getElementById('item-file-upload').addEventListener('change', (e) => { uploadCSV(e.target.files[0], 'items'); e.target.value = ''; });
        document.getElementById('salesman-item-file-upload').addEventListener('change', (e) => { uploadSalesmanItemsCSV(e.target.files[0]); e.target.value = ''; });
        
        const editModal = document.getElementById('edit-modal'); 
        document.getElementById('edit-customers-btn').addEventListener('click', () => { appState.editing.type = 'customers'; showPage('page-edit-data'); renderEditDataList(); }); 
        document.getElementById('edit-items-btn').addEventListener('click', () => { appState.editing.type = 'items'; showPage('page-edit-data'); renderEditDataList(); }); 
        document.getElementById('edit-data-search').addEventListener('input', (e) => renderEditDataList(e.target.value)); 
        
        const renderEditDataList = (filter = '') => { 
            const isCustomers = appState.editing.type === 'customers'; 
            const data = isCustomers ? appState.customers : appState.items; 
            const container = document.getElementById('edit-data-list'); 
            document.getElementById('edit-data-header').textContent = isCustomers ? 'Edit Customers' : 'Edit Items'; 
            const filtered = data.filter(item => ((isCustomers ? item.Customer : item.ItemName) || '').toLowerCase().includes(filter.toLowerCase())); 
            container.innerHTML = filtered.map(item => `<div class="list-item"><span class="info">${isCustomers ? item.Customer : item.ItemName}</span><button class="list-item-action" data-id="${item.id}">Edit</button></div>`).join(''); 
        }; 
        
        document.getElementById('edit-data-list').addEventListener('click', (e) => { 
            if(e.target.matches('.list-item-action')) { 
                appState.editing.id = e.target.dataset.id; 
                openEditModal(); 
            } 
        }); 
        
        const openEditModal = () => { 
            const isCustomers = appState.editing.type === 'customers'; 
            const item = (isCustomers ? appState.customers : appState.items).find(i => i.id === appState.editing.id); 
            if (!item) return; 
            const modalBody = document.getElementById('edit-modal-body'); 
            document.getElementById('edit-modal-title').textContent = `Edit ${isCustomers ? 'Customer' : 'Item'}`; 
            if (isCustomers) { 
                modalBody.innerHTML = `
                    <div class="form-group"><label>Customer Name</label><input type="text" id="edit-Customer" value="${item.Customer || ''}"></div>
                    <div class="form-group"><label>Salesman</label><select id="edit-Salesman"><option>UNNI</option><option>RIYAS</option></select></div>
                    <div class="form-group"><label>Phone</label><input type="text" id="edit-Phone" value="${item.Phone || ''}"></div>
                    <div class="form-group"><label>Outstanding Balance</label><input type="number" id="edit-Outstanding" value="${item.Outstanding || '0'}"></div>
                `; 
                document.getElementById('edit-Salesman').value = item.Salesman; 
            } else { 
                modalBody.innerHTML = `
                    <div class="form-group"><label>Item Name</label><input type="text" id="edit-ItemName" value="${item.ItemName}"></div>
                    <div class="form-group"><label>Cost Rate</label><input type="number" id="edit-CostRate" value="${item.CostRate}"></div>
                    <div class="form-group"><label>Price 1</label><input type="number" id="edit-Price1" value="${item.Price1}"></div>
                    <div class="form-group"><label>Price 2</label><input type="number" id="edit-Price2" value="${item.Price2}"></div>
                    <div class="form-group"><label>Price 3</label><input type="number" id="edit-Price3" value="${item.Price3}"></div>
                `; 
            } 
            editModal.classList.add('active'); 
        };
        const closeEditModal = () => { editModal.classList.remove('active'); }; document.getElementById('close-edit-modal-btn').addEventListener('click', closeEditModal); document.getElementById('save-edit-btn').addEventListener('click', async () => { const isCustomers = appState.editing.type === 'customers'; const id = appState.editing.id; let updatedData = {}; if (isCustomers) { updatedData = { Customer: document.getElementById('edit-Customer').value, Salesman: document.getElementById('edit-Salesman').value, Phone: document.getElementById('edit-Phone').value, Outstanding: parseFloat(document.getElementById('edit-Outstanding').value) || 0 }; } else { const fields = ['ItemName', 'CostRate', 'Price1', 'Price2', 'Price3']; fields.forEach(field => { const input = document.getElementById(`edit-${field}`); updatedData[field] = input.type === 'number' ? parseFloat(input.value) : input.value; }); } await updateDoc(doc(db, isCustomers ? 'customers' : 'items', id), updatedData); closeEditModal(); if (document.getElementById('page-customer-profile').classList.contains('active')) { appState.customer = { ...appState.customer, ...updatedData }; renderCustomerProfile(); } showProfessionalModal('Success', 'Record updated successfully!'); });
        const pageCrm = document.getElementById('page-crm'); const renderCrmModule = () => { appState.flyerBuilder.items = []; const salesmanFilter = document.getElementById('crm-salesman-filter'); const routeFilter = document.getElementById('crm-route-filter'); const salesmen = [...new Set(appState.customers.map(c => c.Salesman).filter(Boolean))].sort(); salesmanFilter.innerHTML = '<option value="ALL">All Salesmen</option>' + salesmen.map(s => `<option value="${s}">${s}</option>`).join(''); const routes = [...new Set(appState.customers.map(c => c.Route).filter(Boolean))].sort(); routeFilter.innerHTML = '<option value="ALL">All Routes</option>' + routes.map(r => `<option value="${r}">${r}</option>`).join(''); updateCrmCustomerCount(); document.getElementById('crm-flyer-headline').value = ''; document.getElementById('crm-flyer-preview-container').innerHTML = `<p style="color:#888;">Flyer preview will appear here.</p>`; document.getElementById('share-bulk-flyer-btn').style.display = 'none'; document.getElementById('generate-bulk-flyer-btn').style.display = 'block'; document.getElementById('crm-flyer-builder-content').style.display = 'block'; renderCrmFlyerItems(); }; const renderCrmFlyerItems = () => { const listContainer = document.getElementById('crm-flyer-item-list'); if (appState.flyerBuilder.items.length === 0) { listContainer.innerHTML = `<p style="text-align:center; color:#888;">No items added to flyer yet.</p>`; return; } listContainer.innerHTML = appState.flyerBuilder.items.map((flyerItem, index) => `<div class="offer-builder-item"><div class="item-info"><div class="item-name">${flyerItem.item.ItemName}</div><div class="item-price">Offer Price: ${formatPreciseCurrency(flyerItem.price)}</div></div><button class="item-action-btn edit-btn" data-index="${index}"><svg viewBox="0 0 24 24" fill="none" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button><button class="item-action-btn delete-btn" data-index="${index}"><svg viewBox="0 0 24 24" fill="none" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button></div>`).join(''); }; pageCrm.addEventListener('input', e => { if(e.target.id === 'offer-item-search-input-bulk') { renderItemSearchResults(e.target.value, 'offer-item-search-results-bulk'); } }); pageCrm.addEventListener('click', e => { const resultItem = e.target.closest('#offer-item-search-results-bulk .search-result-item'); if(resultItem) { const code = resultItem.dataset.itemCode; const fullItem = appState.items.find(i => i.Code == code); if (fullItem && !appState.flyerBuilder.items.some(fi => fi.item.Code === fullItem.Code)) { appState.flyerBuilder.items.push({ item: fullItem, price: fullItem.Price2 }); renderCrmFlyerItems(); } document.getElementById('offer-item-search-input-bulk').value = ''; document.getElementById('offer-item-search-results-bulk').innerHTML = ''; } const deleteBtn = e.target.closest('#crm-flyer-item-list .delete-btn'); if(deleteBtn) { appState.flyerBuilder.items.splice(parseInt(deleteBtn.dataset.index), 1); renderCrmFlyerItems(); } const editBtn = e.target.closest('#crm-flyer-item-list .edit-btn'); if (editBtn) { const index = parseInt(editBtn.dataset.index); const flyerItem = appState.flyerBuilder.items[index]; const newPrice = prompt(`Enter new offer price for ${flyerItem.item.ItemName}:`, flyerItem.price); if (newPrice !== null && !isNaN(parseFloat(newPrice))) { flyerItem.price = parseFloat(newPrice); renderCrmFlyerItems(); } } }); const updateCrmCustomerCount = () => { const selectedSalesman = document.getElementById('crm-salesman-filter').value; const selectedRoute = document.getElementById('crm-route-filter').value; const targetCustomers = appState.customers.filter(c => { const hasPhone = c.Phone && c.Phone.trim().length > 5; const matchesSalesman = selectedSalesman === 'ALL' || c.Salesman === selectedSalesman; const matchesRoute = selectedRoute === 'ALL' || c.Route === selectedRoute; return hasPhone && matchesSalesman && matchesRoute; }); document.getElementById('crm-customer-count').textContent = `Targeted Customers: ${targetCustomers.length}`; }; const generateBulkFlyer = async () => { const generateBtn = document.getElementById('generate-bulk-flyer-btn'); const previewContainer = document.getElementById('crm-flyer-preview-container'); if (appState.flyerBuilder.items.length === 0) { alert("Please add at least one item to the flyer."); return; } generateBtn.disabled = true; generateBtn.innerHTML = 'Generating...'; previewContainer.innerHTML = '...'; const headline = document.getElementById('crm-flyer-headline').value.trim() || 'A Special Offer For You!'; const itemsHtml = appState.flyerBuilder.items.map(item => `<li class="flyer-item"><span class="flyer-item-name">${item.item.ItemName}</span><span class="flyer-item-price">${formatPreciseCurrency(item.price)}</span></li>`).join(''); document.getElementById('flyer-template-wrapper').innerHTML = `<div id="flyer-content"><div id="flyer-header"><h2 id="flyer-logo">MF BIGMARKET</h2><p id="flyer-tagline">Quality Products, Delivered.</p></div><div id="flyer-offer-details"><h3 id="flyer-headline">${headline}</h3><ul id="flyer-item-list">${itemsHtml}</ul></div><div id="flyer-footer"><p>Contact your salesman to order today!</p></div></div>`; try { const canvas = await html2canvas(document.getElementById('flyer-template-wrapper'), { scale: 2, useCORS: true, backgroundColor: null }); const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.9)); appState.bulkFlyerBlob = blob; const imgEl = document.createElement('img'); imgEl.src = URL.createObjectURL(blob); previewContainer.innerHTML = ''; previewContainer.appendChild(imgEl); document.getElementById('share-bulk-flyer-btn').style.display = 'block'; } catch (error) { console.error("Bulk flyer generation error:", error); previewContainer.innerHTML = '<p style="color:red;">Error generating flyer image.</p>'; } finally { generateBtn.disabled = false; generateBtn.innerHTML = 'Generate Flyer Preview'; } };
    document.getElementById('generate-bulk-flyer-btn').addEventListener('click', generateBulkFlyer); document.getElementById('share-bulk-flyer-btn').addEventListener('click', async () => { const flyerBlob = appState.bulkFlyerBlob; if (!flyerBlob) { alert('Please generate a flyer first.'); return; } const targetCount = document.getElementById('crm-customer-count').textContent; if(!confirm(`Your flyer is ready. You will now be prompted to share it with your selected ${targetCount}. Continue?`)){ return; } try { const file = new File([flyerBlob], 'MF-BigMarket-Offer.jpg', { type: 'image/jpeg' }); const shareText = document.getElementById('crm-flyer-headline').value.trim() || 'Check out our latest deals!'; if (navigator.share && navigator.canShare({ files: [file] })) { await navigator.share({ files: [file], title: 'MF BigMarket Offer', text: shareText }); } else { alert("Sharing not supported on this browser. You can save the image by long-pressing it and share manually."); } } catch (error) { console.error('Bulk Share failed:', error); alert("Could not share automatically. Please save the image and send it manually."); } });
    document.getElementById('back-to-admin-from-crm-btn').addEventListener('click', () => showPage('page-admin-dashboard')); document.getElementById('crm-salesman-filter').addEventListener('change', updateCrmCustomerCount); document.getElementById('crm-route-filter').addEventListener('change', updateCrmCustomerCount);
    
    document.querySelector('#page-product-info .search-toggle-buttons').addEventListener('click', e => { if (e.target.matches('.toggle-btn')) { const searchType = e.target.dataset.searchType; document.querySelectorAll('#page-product-info .toggle-btn').forEach(btn => btn.classList.remove('active')); e.target.classList.add('active'); document.querySelectorAll('#page-product-info .search-view').forEach(view => view.classList.remove('active')); document.getElementById(`${searchType}-search-view`).classList.add('active'); document.getElementById(`${searchType === 'info-salesman' ? 'info-salesman-item-search-input' : 'info-item-search-input'}`).focus(); } });
    document.getElementById('info-salesman-item-search-input').addEventListener('input', (e) => renderSalesmanItemSearchResults(e.target.value, 'info-salesman-item-search-results'));
    document.getElementById('info-item-search-input').addEventListener('input', (e) => renderItemSearchResults(e.target.value, 'info-item-search-results'));
    
    const renderProductInfoCard = (item) => {
        const container = document.getElementById('product-info-display-card'); if (!item) { container.style.display = 'none'; return; }
        container.innerHTML = `<h3>${item.ItemName}</h3><div class="price-grid"><div class="price-item"><div class="label">Price 1</div><div class="value">${formatPreciseCurrency(item.Price1)}</div></div><div class="price-item"><div class="label">Price 2</div><div class="value">${formatPreciseCurrency(item.Price2)}</div></div><div class="price-item"><div class="label">Price 3</div><div class="value">${formatPreciseCurrency(item.Price3)}</div></div></div><p class="stock-info">Current Stock: ${item.Clstock} ${item.Unit || ''}</p>`; container.style.display = 'block';
    };
    const handleInfoItemSelection = (itemElement) => { if (itemElement) { const code = itemElement.dataset.itemCode; const selectedItem = appState.items.find(i => i.Code == code); document.getElementById('info-item-search-input').value = ''; document.getElementById('info-salesman-item-search-input').value = ''; document.getElementById('info-item-search-results').innerHTML = ''; document.getElementById('info-salesman-item-search-results').innerHTML = ''; renderProductInfoCard(selectedItem); } };
    document.getElementById('info-salesman-item-search-results').addEventListener('click', (e) => handleInfoItemSelection(e.target.closest('.search-result-item')));
    document.getElementById('info-item-search-results').addEventListener('click', (e) => handleInfoItemSelection(e.target.closest('.search-result-item')));

    document.getElementById('back-to-history-from-edit-btn').addEventListener('click', () => showPage('page-order-history'));

    // --- OUTSTANDING BALANCES PAGE LOGIC ---
    const renderOutstandingBalancesPage = () => {
        const container = document.getElementById('outstanding-list-container');
        const totalValueEl = document.getElementById('total-outstanding-value');
        
        populateRoutes('outstanding-route-filter');
        const searchFilter = document.getElementById('outstanding-search-input').value.toLowerCase();
        const selectedRoute = document.getElementById('outstanding-route-filter').value;

        let filteredCustomers = appState.customers
            .filter(c => c.Salesman && c.Salesman.toUpperCase() === appState.salesman && (c.Customer || '').toLowerCase().includes(searchFilter) && (selectedRoute === 'ALL' || c.Route === selectedRoute));

        const totalOutstanding = filteredCustomers.reduce((sum, c) => sum + (c.Outstanding || 0), 0);
        totalValueEl.textContent = formatCurrency(totalOutstanding);
        
        if (appState.outstandingSort === 'desc') {
            filteredCustomers.sort((a, b) => (b.Outstanding || 0) - (a.Outstanding || 0));
        } else if (appState.outstandingSort === 'asc') {
            filteredCustomers.sort((a, b) => (a.Outstanding || 0) - (b.Outstanding || 0));
        } else {
            filteredCustomers.sort((a, b) => (a.Customer || '').localeCompare(b.Customer || ''));
        }

        if (filteredCustomers.length === 0) {
            container.innerHTML = `<p class="card" style="text-align: center;">No customers found for the selected filters.</p>`;
            return;
        }

        container.innerHTML = filteredCustomers.map(c => `
            <div class="list-item" data-customer-id="${c.id}" data-customer-name="${c.Customer}">
                <div class="info">${c.Customer}</div>
                <input type="number" class="outstanding-balance" value="${c.Outstanding || 0}" readonly />
                <button class="reminder-btn" data-customer='${JSON.stringify(c)}'>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                </button>
            </div>
        `).join('');
    };
    
    document.getElementById('outstanding-search-input').addEventListener('input', renderOutstandingBalancesPage);
    document.getElementById('outstanding-route-filter').addEventListener('change', renderOutstandingBalancesPage);
    
    document.getElementById('outstanding-sort-btn').addEventListener('click', (e) => {
        const btn = e.currentTarget;
        if (appState.outstandingSort === 'default') {
            appState.outstandingSort = 'desc';
            btn.textContent = 'Sort: High to Low';
        } else if (appState.outstandingSort === 'desc') {
            appState.outstandingSort = 'asc';
            btn.textContent = 'Sort: Low to High';
        } else {
            appState.outstandingSort = 'default';
            btn.textContent = 'Sort by Amount';
        }
        renderOutstandingBalancesPage();
    });
    
    const outstandingListContainer = document.getElementById('outstanding-list-container');
    
    outstandingListContainer.addEventListener('click', async (e) => {
        const reminderBtn = e.target.closest('.reminder-btn');
        if (reminderBtn) {
            reminderBtn.disabled = true;
            const customer = JSON.parse(reminderBtn.dataset.customer);
            await generateAndShareReceipt('outstanding', customer, customer.Outstanding || 0);
            reminderBtn.disabled = false;
        }
    });
    
    
    // --- PACKER (SUNNY) ---
    const renderPackerHome = () => {
        const container = document.getElementById('packer-order-list');
        const { start, end } = getReportDateRange();
        let allOrders = Object.values(appState.orders).flat().filter(o => o.status === 'pending');
        
        if (start && end) {
            allOrders = allOrders.filter(o => {
                const orderDate = new Date(o.date);
                return orderDate >= start && orderDate <= end;
            });
        }
         allOrders.sort((a,b) => new Date(b.date) - new Date(a.date));

        container.innerHTML = allOrders.map(o => `
            <div class="list-item" data-order-id="${o.id}">
                <div class="info">${o.customer.Customer} (${o.salesman})</div>
                <button class="list-item-action pack-order-btn" data-order-id="${o.id}">Pack</button>
            </div>
        `).join('');
    };
    
    document.getElementById('packer-order-list').addEventListener('click', e => {
        const packBtn = e.target.closest('.pack-order-btn');
        if(packBtn) {
            const orderId = packBtn.dataset.orderId;
            const order = Object.values(appState.orders).flat().find(o => o.id === orderId);
            appState.packingOrder = JSON.parse(JSON.stringify(order)); // Deep copy
            showPage('page-packing-interface');
            renderPackingInterface();
        }
    });
    
    const renderPackingInterface = () => {
        const order = appState.packingOrder;
        document.getElementById('packing-order-customer').textContent = `Packing for ${order.customer.Customer}`;
        const itemList = document.getElementById('packing-item-list');
        itemList.innerHTML = order.items.map((itemData, index) => `
            <div class="list-item">
                <input type="checkbox" data-index="${index}" ${itemData.wasUnchecked ? '' : 'checked'}>
                <div class="info">
                    <span class="packing-item-name">${itemData.item.ItemName}</span>
                    <span class="packing-item-details">
                        QTY: ${itemData.quantity} ${itemData.item.Unit || ''} | MRP: ${formatPreciseCurrency(itemData.item.Mrp)}
                    </span>
                </div>
            </div>
        `).join('');
    };
    
    document.getElementById('packing-item-search').addEventListener('input', e => {
        renderItemSearchResults(e.target.value, 'packing-item-search-results');
    });

    document.getElementById('packing-item-search-results').addEventListener('click', e => {
        const resultItem = e.target.closest('.search-result-item');
        if (resultItem) {
            const item = appState.items.find(i => i.Code == resultItem.dataset.itemCode);
            const qty = prompt(`Enter quantity for ${item.ItemName}:`);
            const qtyNum = parseFloat(qty);
            if(qty && !isNaN(qtyNum) && qtyNum > 0) {
                appState.packingOrder.items.push({ item, quantity: qtyNum, sellingPrice: item.Price2, isNew: true });
                renderPackingInterface();
            }
            document.getElementById('packing-item-search').value = '';
            document.getElementById('packing-item-search-results').innerHTML = '';
        }
    });
   
    document.getElementById('confirm-packing-btn').addEventListener('click', async () => {
        const packingOrder = appState.packingOrder;
        const packedOrderId = packingOrder.id;

        const checkboxes = document.querySelectorAll('#packing-item-list input[type="checkbox"]');
        
        packingOrder.items.forEach((item, index) => {
            const checkbox = document.querySelector(`#packing-item-list input[data-index="${index}"]`);
            if (checkbox && !checkbox.checked) {
                item.wasUnchecked = true;
            } else {
                delete item.wasUnchecked;
            }
        });
        
        const updateData = {
            status: 'packed',
            packedItems: packingOrder.items
        };

        try {
            await updateDoc(doc(db, "orders", packedOrderId), updateData);
            showPage('page-packer-home');

            const itemToRemove = document.querySelector(`#packer-order-list .list-item[data-order-id="${packedOrderId}"]`);
            if(itemToRemove) {
                itemToRemove.classList.add('removing');
                setTimeout(() => itemToRemove.remove(), 500);
            }
            
            showProfessionalModal('Success', 'Order has been marked as packed.');

        } catch (error) {
            console.error("Error confirming packing:", error);
            alert("Failed to confirm packing.");
        } finally {
             appState.packingOrder = null;
        }
    });
    
    const renderPackerHistory = () => {
         const container = document.getElementById('packer-history-list');
        let allOrders = Object.values(appState.orders).flat().filter(o => o.status === 'packed');
         allOrders.sort((a, b) => new Date(b.date) - new Date(a.date));
         
        if (allOrders.length === 0) {
            container.innerHTML = `<p class="card" style="text-align:center;">No packed orders found.</p>`;
            return;
        }

        container.innerHTML = allOrders.map(o => `
            <div class="history-card" data-id="${o.id}">
                <div class="history-card-header">
                    <div class="info">
                       <p><strong>Customer:</strong> ${o.customer.Customer}</p>
                       <p><strong>Salesman:</strong> ${o.salesman}</p>
                       <p class="date-display">${formatDDMMYYYYTime(o.date)}</p>
                    </div>
                    <div class="actions">
                        <button class="button button-outline undo-pack-btn" style="padding: 5px 10px; font-size: 0.8rem;">Undo</button>
                    </div>
                </div>
            </div>
        `).join('');
    };

    document.getElementById('packer-history-list').addEventListener('click', async e => {
        const undoBtn = e.target.closest('.undo-pack-btn');
        if (undoBtn) {
            const card = undoBtn.closest('.history-card');
            const orderId = card.dataset.id;
            if (confirm('Are you sure you want to undo this packing? This will move the order back to the pending list.')) {
                try {
                    await updateDoc(doc(db, "orders", orderId), { 
                        status: 'pending',
                        packedItems: deleteField() 
                    });
                    showToast('Packing undone. Order is now pending.');
                    card.classList.add('removing');
                    setTimeout(() => card.remove(), 400);
                } catch (error) {
                    console.error("Error undoing pack status:", error);
                    alert('Failed to undo packing.');
                }
            }
        }
    });
    
    const renderPackedOrders = () => {
        const container = document.getElementById('packed-orders-list');
        const salesmanOrders = (appState.orders[appState.salesman] || []).filter(o => o.status === 'packed').sort((a, b) => new Date(b.date) - new Date(a.date));
        const costMap = new Map(appState.items.map(i => [String(i.Code), parseFloat(i.CostRate) || 0]));

        if (salesmanOrders.length === 0) {
            container.innerHTML = `<p class="card" style="text-align:center;">No packed orders to display.</p>`;
            return;
        }

        container.innerHTML = salesmanOrders.map(order => {
            let finalTotal = 0;
            let finalCost = 0;
            const itemsToProcess = order.packedItems || order.items;
            
            const itemDetailsHtml = (itemsToProcess).map(i => {
                let style = '';
                if (i.wasUnchecked) {
                    style = 'background-color: #ffebee; color: #c62828;'; // Light red tone
                } else if (i.isNew) {
                     style = 'background-color: #e8f5e9; color: #2e7d32;'; // Light green tone
                }

                if (!i.wasUnchecked) {
                    const lineTotal = (i.quantity || 0) * (i.sellingPrice || 0);
                    const lineCost = (i.quantity || 0) * (costMap.get(String(i.item.Code)) || 0);
                    finalTotal += lineTotal;
                    finalCost += lineCost;
                }
                
                return `<tr style="${style}">
                            <td class="col-item-name">${i.item.ItemName}</td>
                            <td class="numeric">${i.wasUnchecked ? 'REMOVED' : `${i.quantity} ${i.item.Unit || ""}`}</td>
                            <td class="numeric">${i.wasUnchecked ? '-' : formatPreciseCurrency(i.sellingPrice)}</td>
                            <td class="numeric"><strong>${i.wasUnchecked ? '-' : formatPreciseCurrency((i.quantity || 0) * (i.sellingPrice || 0))}</strong></td>
                        </tr>`;
            }).join('');

            const totalProfit = finalTotal - finalCost;
            const margin = finalTotal > 0 ? (totalProfit / finalTotal) * 100 : 0;
            const profitClass = totalProfit >= 0 ? 'profit' : 'loss';
            const profitHtml = `<p><strong>Profit:</strong> <span class="${profitClass}">${formatPreciseCurrency(totalProfit)} (${margin.toFixed(1)}%)</span></p>`;

            return `
                <div class="history-card">
                    <div class="history-card-header">
                        <div class="info">
                           <p><strong>Customer:</strong> ${order.customer.Customer}</p>
                           <p><strong>Final Total:</strong> ${formatPreciseCurrency(finalTotal)}</p>
                           ${profitHtml}
                           <p class="date-display">${formatDDMMYYYYTime(order.date)}</p>
                        </div>
                    </div>
                    <div class="history-card-body" id="packed-details-${order.id}">
                        <div class="table-responsive-wrapper">
                            <table class="history-item-table">
                                <thead><tr><th class="col-item-name">Item</th><th class="numeric">Qty / Unit</th><th class="numeric">Price</th><th class="numeric">Total</th></tr></thead>
                                <tbody>${itemDetailsHtml}</tbody>
                            </table>
                        </div>
                    </div>
                    <a class="toggle-details" data-target="packed-details-${order.id}">View Details</a>
                </div>`;
        }).join('');
        
        container.querySelectorAll('.toggle-details').forEach(btn => {
            btn.addEventListener('click', e => {
                e.preventDefault();
                const target = document.getElementById(e.currentTarget.dataset.target);
                if (target) target.classList.toggle('visible');
            });
        });
    };
    
    
    document.getElementById('packer-logout-btn').addEventListener('click', handleLogout);
    document.getElementById('packer-history-btn').addEventListener('click', () => { showPage('page-packer-history'); renderPackerHistory(); });
    document.getElementById('back-to-packer-home-btn').addEventListener('click', () => showPage('page-packer-home'));
    document.getElementById('back-to-packer-home-from-history-btn').addEventListener('click', () => showPage('page-packer-home'));
    document.getElementById('packed-orders-btn').addEventListener('click', () => { showPage('page-packed-orders'); renderPackedOrders(); });
    document.getElementById('back-to-main-from-packed-orders-btn').addEventListener('click', () => showPage('page-main-view'));
    setupBetweenDateFilter('packer-date-filter', renderPackerHome);


    const setupPWA = () => { const manifest = { name: "MF BigMarket Orders", short_name: "BigMarket", start_url: ".", display: "standalone", background_color: "#e0f7fa", theme_color: "#005f73", description: "An order and payment management app.", icons: [{ src: "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxOTIgMTkyIj48Y2lyY2xlIGN4PSI5NiIgY3k9Ijk2IiByPSI5NiIgZmlsbD0iIzAwNWY3MyIvPjx0ZXh0IHg9Ijk2IiB5PSIxMzYiIGZvbnQtZm1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iOTAiIGZvbnQtd2VpZ2h0PSJib2xkIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjZmZmIj5NRjwvdGV4dD48L3N2Zz4=", sizes: "192x192", type: "image/svg+xml" }]}; const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'}); const manifestUrl = URL.createObjectURL(manifestBlob); document.querySelector('head').insertAdjacentHTML('beforeend', `<link rel="manifest" href="${manifestUrl}">`); if ('serviceWorker' in navigator && (location.protocol === 'https' || location.hostname === 'localhost')) { const swCode = `const CACHE_NAME = 'mf-bigmarket-v3'; const URLS_TO_CACHE = []; self.addEventListener('install', e => e.waitUntil(caches.open(CACHE_NAME))); self.addEventListener('fetch', e => e.respondWith(caches.match(e.request).then(r => r || fetch(e.request).catch(() => caches.match('/')))));`; const swBlob = new Blob([swCode], { type: 'application/javascript' }); const swUrl = URL.createObjectURL(swBlob); window.addEventListener('load', () => { navigator.serviceWorker.register(swUrl).then(reg => console.log('SW registered.')).catch(err => console.log('SW registration failed: ', err)); }); } };
    
    setupPWA();
    setupRealtimeListeners(); 
});
</script>
</body>
</html>